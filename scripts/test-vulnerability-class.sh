#!/bin/bash

# Test script for Issue #16: vulnerability_class field
# Expected: All tests FAIL in RED phase (except TC-00)

PASS=0
FAIL=0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

pass() {
    echo -e "${GREEN}PASS${NC}: $1"
    ((PASS++))
}

fail() {
    echo -e "${RED}FAIL${NC}: $1"
    ((FAIL++))
}

echo "=========================================="
echo "Testing vulnerability_class feature"
echo "=========================================="

# TC-00: Test script exists (meta test)
if [[ -f "scripts/test-vulnerability-class.sh" ]]; then
    pass "TC-00: test-vulnerability-class.sh exists"
else
    fail "TC-00: test-vulnerability-class.sh exists"
fi

# TC-01: reference.md has schema_version definition
if grep -q "schema_version" plugins/redteam-core/skills/security-scan/reference.md 2>/dev/null; then
    pass "TC-01: reference.md has schema_version definition"
else
    fail "TC-01: reference.md has schema_version definition"
fi

# TC-02: vulnerabilities has vulnerability_class required field
if grep -q "vulnerability_class" plugins/redteam-core/skills/security-scan/reference.md 2>/dev/null; then
    pass "TC-02: vulnerabilities has vulnerability_class field"
else
    fail "TC-02: vulnerabilities has vulnerability_class field"
fi

# TC-03: vulnerabilities has cwe_id optional field
if grep -q "cwe_id" plugins/redteam-core/skills/security-scan/reference.md 2>/dev/null; then
    pass "TC-03: vulnerabilities has cwe_id field"
else
    fail "TC-03: vulnerabilities has cwe_id field"
fi

# TC-04: existing type field is maintained
if grep -q '"type":' plugins/redteam-core/skills/security-scan/reference.md 2>/dev/null; then
    pass "TC-04: existing type field is maintained"
else
    fail "TC-04: existing type field is maintained"
fi

# TC-05: injection-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/injection-attacker.md 2>/dev/null; then
    pass "TC-05: injection-attacker has vulnerability_class"
else
    fail "TC-05: injection-attacker has vulnerability_class"
fi

# TC-06: xss-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/xss-attacker.md 2>/dev/null; then
    pass "TC-06: xss-attacker has vulnerability_class"
else
    fail "TC-06: xss-attacker has vulnerability_class"
fi

# TC-07: ssrf-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/ssrf-attacker.md 2>/dev/null; then
    pass "TC-07: ssrf-attacker has vulnerability_class"
else
    fail "TC-07: ssrf-attacker has vulnerability_class"
fi

# TC-08: auth-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/auth-attacker.md 2>/dev/null; then
    pass "TC-08: auth-attacker has vulnerability_class"
else
    fail "TC-08: auth-attacker has vulnerability_class"
fi

# TC-09: api-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/api-attacker.md 2>/dev/null; then
    pass "TC-09: api-attacker has vulnerability_class"
else
    fail "TC-09: api-attacker has vulnerability_class"
fi

# TC-10: file-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/file-attacker.md 2>/dev/null; then
    pass "TC-10: file-attacker has vulnerability_class"
else
    fail "TC-10: file-attacker has vulnerability_class"
fi

# TC-11: crypto-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/crypto-attacker.md 2>/dev/null; then
    pass "TC-11: crypto-attacker has vulnerability_class"
else
    fail "TC-11: crypto-attacker has vulnerability_class"
fi

# TC-12: error-attacker has vulnerability_class
if grep -q "vulnerability_class" plugins/redteam-core/agents/error-attacker.md 2>/dev/null; then
    pass "TC-12: error-attacker has vulnerability_class"
else
    fail "TC-12: error-attacker has vulnerability_class"
fi

# TC-13: All agents maintain existing type field in Output Format
AGENTS="injection-attacker xss-attacker ssrf-attacker auth-attacker api-attacker file-attacker crypto-attacker error-attacker"
ALL_HAVE_TYPE=true
for agent in $AGENTS; do
    if ! grep -A 20 "Output Format" "plugins/redteam-core/agents/${agent}.md" 2>/dev/null | grep -q '"type":'; then
        ALL_HAVE_TYPE=false
        break
    fi
done
if $ALL_HAVE_TYPE; then
    pass "TC-13: All agents maintain existing type field"
else
    fail "TC-13: All agents maintain existing type field"
fi

# TC-14: schema_version default behavior is defined
if grep -qE "schema_version.*1\.0|未指定.*1\.0|default.*1\.0" plugins/redteam-core/skills/security-scan/reference.md 2>/dev/null; then
    pass "TC-14: schema_version default behavior is defined"
else
    fail "TC-14: schema_version default behavior is defined"
fi

echo ""
echo "=========================================="
echo "Results: $PASS passed, $FAIL failed"
echo "=========================================="

# Exit with failure if any test failed
if [[ $FAIL -gt 0 ]]; then
    exit 1
fi
exit 0
