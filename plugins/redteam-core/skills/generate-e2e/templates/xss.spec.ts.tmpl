import { test, expect } from '@playwright/test';

/**
 * XSS Security E2E Tests
 * Generated by redteam-skills generate-e2e
 *
 * PURPOSE: PoC (Proof of Concept) verification for XSS vulnerabilities.
 * These tests PASS when XSS payload executes (vulnerability EXISTS).
 * Use for security auditing, not regression testing.
 *
 * WARNING: These tests send attack payloads to the target.
 * Only run against authorized targets.
 */

const XSS_PAYLOADS = [
  '<script>window.xssTriggered=true</script>',
  '<img src=x onerror="window.xssTriggered=true">',
  '<svg onload="window.xssTriggered=true">',
];

test.describe('XSS Security Tests', () => {
  /**
   * Reflected XSS Test
   * Injects payload via URL parameter and checks for script execution
   */
  test('{{VULN_ID}}: Reflected XSS at {{ENDPOINT}}', async ({ page }) => {
    for (const payload of XSS_PAYLOADS) {
      // Reset trigger flag
      await page.goto('{{ENDPOINT}}');
      await page.evaluate(() => { (window as any).xssTriggered = false; });

      // Inject payload via URL parameter
      const targetUrl = '{{ENDPOINT}}?{{PARAM_NAME}}=' + encodeURIComponent(payload);
      await page.goto(targetUrl);

      // Check if XSS was triggered
      const triggered = await page.evaluate(() => (window as any).xssTriggered);
      expect(triggered).toBe(true);
    }
  });

  /**
   * DOM XSS Test
   * Tests for DOM-based XSS via innerHTML or document.write
   */
  test('{{VULN_ID}}: DOM XSS at {{ENDPOINT}}', async ({ page }) => {
    await page.goto('{{ENDPOINT}}');

    // Verify target element exists
    const targetElement = page.locator('{{INPUT_SELECTOR}}');
    await expect(targetElement).toBeVisible({ timeout: 5000 });

    for (const payload of XSS_PAYLOADS) {
      // Reset trigger flag
      await page.evaluate(() => { (window as any).xssTriggered = false; });

      // Simulate DOM manipulation (innerHTML injection)
      await page.evaluate((p) => {
        const target = document.querySelector('{{INPUT_SELECTOR}}');
        if (target) {
          target.innerHTML = p;
        }
      }, payload);

      // Check if XSS was triggered
      const triggered = await page.evaluate(() => (window as any).xssTriggered);
      expect(triggered).toBe(true);
    }
  });

  /**
   * Stored XSS Test
   * Submits payload, then navigates to view page to check execution
   */
  test('{{VULN_ID}}: Stored XSS at {{ENDPOINT}}', async ({ page }) => {
    const payload = XSS_PAYLOADS[0];

    // Step 1: Navigate and verify form elements exist
    await page.goto('{{ENDPOINT}}');
    const inputField = page.locator('{{INPUT_SELECTOR}}');
    const submitButton = page.locator('button[type="submit"]');
    await expect(inputField).toBeVisible({ timeout: 5000 });
    await expect(submitButton).toBeVisible({ timeout: 5000 });

    // Step 2: Submit/save payload
    await inputField.fill(payload);
    await submitButton.click();

    // Step 3: Navigate to view page
    await page.goto('{{VIEW_ENDPOINT}}');

    // Step 4: Check if stored XSS was triggered
    const triggered = await page.evaluate(() => (window as any).xssTriggered);
    expect(triggered).toBe(true);
  });
});
