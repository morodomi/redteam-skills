# TDD Cycle: auth-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | auth-attacker 認証攻撃エージェント |
| Issue | #7 |
| Phase | DONE |
| Started | 2024-12-24 14:51 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

認証・認可に関する脆弱性を検出するエージェントを実装する。

### MVP対象
- Broken Authentication
- Broken Access Control
- Session Management Issues

## PLAN

### スコープ

auth-attackerエージェントファイルの作成。静的解析による認証・認可脆弱性の検出。

### ファイル構成

```
plugins/redteam-core/agents/
└── auth-attacker.md    # 認証攻撃エージェント定義
```

### エージェント設計

```yaml
name: auth-attacker
description: 認証・認可脆弱性検出エージェント。静的解析でBroken Auth/Access Control脆弱性を検出。
allowed-tools: Read, Grep, Glob
```

### 検出対象（MVP）

| Type | Description | Pattern |
|------|-------------|---------|
| Hardcoded Credentials | ハードコードされた認証情報 | パスワード/APIキー直書き |
| Missing Auth Check | 認証チェック漏れ | ミドルウェア/ガード不在 |
| Broken Access Control | 認可チェック漏れ | 権限確認なしのリソースアクセス |
| Weak Session | 弱いセッション管理 | 短いセッションID、HTTPのみクッキー |

### フレームワーク別検出パターン

| Framework | Vulnerable Pattern | Safe Pattern |
|-----------|-------------------|--------------|
| Laravel | Route without middleware, `Auth::check()` missing | `->middleware('auth')`, Gate/Policy |
| Django | View without `@login_required` | `@login_required`, `PermissionRequiredMixin` |
| Flask | Route without `@login_required` | Flask-Login decorators |
| Express | Route without auth middleware | passport.authenticate(), jwt middleware |

### 危険パターン（Grep対象）

```yaml
patterns:
  # Hardcoded Credentials
  - 'password\s*=\s*["\'][^"\']+["\']'
  - 'api_key\s*=\s*["\'][^"\']+["\']'
  - 'secret\s*=\s*["\'][^"\']+["\']'

  # Missing Auth (Laravel)
  - 'Route::(get|post|put|delete)\s*\([^)]+\)\s*(?!->middleware)'

  # Missing Auth (Django)
  - 'def\s+\w+\s*\(request[^)]*\):\s*$'

  # Weak Session
  - 'session\.cookie_secure\s*=\s*False'
  - 'SESSION_COOKIE_SECURE\s*=\s*False'
```

### 出力形式

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "agent": "auth-attacker"
  },
  "vulnerabilities": [
    {
      "id": "AUTH-001",
      "type": "hardcoded-credentials",
      "severity": "critical",
      "file": "config/database.php",
      "line": 23,
      "code": "password => 'admin123'",
      "description": "Hardcoded database password",
      "remediation": "Use environment variables"
    }
  ],
  "summary": {
    "total": 1,
    "critical": 1,
    "high": 0,
    "medium": 0,
    "low": 0
  }
}
```

### 重大度基準

| Severity | Criteria |
|----------|----------|
| critical | Hardcoded credentials in production config |
| high | Missing auth on sensitive endpoints |
| medium | Weak session configuration |
| low | Potential auth pattern issue |

### CWE/OWASP マッピング

| Reference | ID |
|-----------|-----|
| CWE | CWE-287: Improper Authentication |
| CWE | CWE-862: Missing Authorization |
| OWASP Top 10 | A01:2021 Broken Access Control |
| OWASP Top 10 | A07:2021 Identification and Authentication Failures |

## Test List

### TODO
- [ ] TC-01: auth-attacker.md が存在する
- [ ] TC-02: YAML frontmatter（name, description, allowed-tools）が存在する
- [ ] TC-03: 検出対象セクション（Hardcoded Credentials, Missing Auth, Broken Access Control）が存在する
- [ ] TC-04: フレームワーク別検出パターン表が存在する
- [ ] TC-05: 危険パターン（Grepパターン）が定義されている
- [ ] TC-06: 出力形式（JSONスキーマ）が存在する
- [ ] TC-07: 重大度基準が存在する
- [ ] TC-08: CWE/OWASPマッピングが存在する

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | エージェント設計、Test List作成 |
| RED | Done | 8テスト作成、全失敗確認 |
| GREEN | Done | auth-attacker.md作成、全テスト成功 |
| REFACTOR | Done | リファクタリング不要（構造クリーン） |
| REVIEW | Done | テスト全PASS、code-review完了（Critical=v0.3.0対象） |
| COMMIT | Done | 1bdc1de |

## References

- [OWASP Broken Authentication](https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/)
- [OWASP Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
