# Cycle: e2e-xss

| Item | Value |
|------|-------|
| Issue | #23 |
| Phase | DONE |
| Created | 2026-01-05 18:15 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |
| Playwright | ^1.40.0 |

## Goal

XSS脆弱性のE2Eテストを自動生成する。xss-attackerの静的解析結果からPlaywrightテストコードを生成。

## Background

#22 (e2e-generator-base) で作成した基盤を使用して、XSS専用のテストテンプレートを追加。

## Scope

From Issue #23:
- [ ] xss-attacker結果からテスト生成
- [ ] Reflected/DOM/Stored XSS テンプレート対応（検出はReflectedのみ、DOM/Storedは #28 で対応）
- [ ] ペイロードバリエーション

## PLAN

### Design

```
xss-attacker JSON → generate-e2e skill → xss.spec.ts
```

### Architecture

| Component | Description |
|-----------|-------------|
| xss.spec.ts.tmpl | XSS専用Playwrightテストテンプレート |
| generate-e2e skill | XSSタイプ判定と適切なテスト生成 |

### XSS Test Strategies

| Type | Test Method | Verification |
|------|-------------|--------------|
| Reflected | URLパラメータにペイロード注入 | `window.xssTriggered` チェック |
| DOM | DOM要素操作→スクリプト実行 | `page.evaluate()` でグローバル変数チェック |
| Stored | ペイロード保存→表示ページアクセス | 表示ページでのスクリプト実行確認 |

### Files to Create

| File | Description |
|------|-------------|
| plugins/redteam-core/skills/generate-e2e/templates/xss.spec.ts.tmpl | XSS専用テストテンプレート |

### Template Variables (Additional)

| Variable | Description | Example |
|----------|-------------|---------|
| {{VULN_ID}} | 脆弱性ID | XSS-001 |
| {{XSS_TYPE}} | XSSタイプ | reflected / dom / stored |
| {{PARAM_NAME}} | パラメータ名（Reflected用） | q, name |
| {{INPUT_SELECTOR}} | 入力要素セレクタ（DOM/Stored用） | #search-input |

### Payload Variations

```typescript
const XSS_PAYLOADS = [
  '<script>window.xssTriggered=true</script>',
  '<img src=x onerror="window.xssTriggered=true">',
  '<svg onload="window.xssTriggered=true">',
  "javascript:window.xssTriggered=true",
];
```

### Output Example

```typescript
// xss.spec.ts (generated)
import { test, expect } from '@playwright/test';

const XSS_PAYLOADS = [
  '<script>window.xssTriggered=true</script>',
  '<img src=x onerror="window.xssTriggered=true">',
];

test.describe('XSS Security Tests', () => {
  test('XSS-001: Reflected XSS at /search', async ({ page }) => {
    for (const payload of XSS_PAYLOADS) {
      await page.goto('/search?q=' + encodeURIComponent(payload));
      const triggered = await page.evaluate(() => (window as any).xssTriggered);
      expect(triggered).toBe(true);
    }
  });
});
```

### References

- [OWASP XSS Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Playwright Evaluate](https://playwright.dev/docs/evaluating)

## Test List

### TODO

### WIP

### DONE
- [x] TC-01: [正常系] Reflected XSS検出結果からテスト生成
- [x] TC-02: [正常系] DOM XSS検出結果からテスト生成
- [x] TC-03: [正常系] Stored XSS検出結果からテスト生成
- [x] TC-04: [正常系] 複数ペイロードでのテスト生成
- [x] TC-05: [境界値] XSS脆弱性0件時の処理
- [x] TC-06: [エッジケース] 特殊文字を含むエンドポイント
- [x] TC-07: [異常系] 不正なXSSタイプ指定時のエラー

## Notes

- 依存: #22 e2e-generator-base (完了)
- XSSタイプ: Reflected, DOM, Stored（テンプレートのみ、検出は #28 で拡張予定）
- ペイロード: OWASP推奨の代表的なベクター
- 関連: #28 xss-attacker DOM/Stored検出対応
