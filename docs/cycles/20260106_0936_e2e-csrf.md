# Cycle: e2e-csrf

| Item | Value |
|------|-------|
| Issue | #24 |
| Phase | REVIEW |
| Created | 2026-01-06 09:36 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |
| Playwright | ^1.40.0 |

## Goal

CSRF脆弱性のE2Eテストを自動生成する。csrf-attackerの静的解析結果からPlaywrightテストコードを生成。

## Background

#22 (e2e-generator-base)、#23 (e2e-xss) で作成した基盤を使用して、CSRF専用のテストテンプレートを追加。

## Scope

From Issue #24:
- [ ] csrf-attacker結果からテスト生成
- [ ] トークン欠如検証
- [ ] SameSite属性検証

## PLAN

### Design

```
csrf-attacker JSON → generate-e2e skill → csrf.spec.ts
```

### Architecture

| Component | Description |
|-----------|-------------|
| csrf.spec.ts.tmpl | CSRF専用Playwrightテストテンプレート |
| generate-e2e skill | CSRFタイプ判定と適切なテスト生成 |

### CSRF Test Strategies

| Type | Test Method | Verification |
|------|-------------|--------------|
| csrf-token-missing | CSRFトークンなしでPOST送信 | 200レスポンス = 脆弱性あり |
| csrf-protection-disabled | 保護なしで状態変更リクエスト | 変更成功 = 脆弱性あり |
| samesite-cookie-missing | Cookie属性検査 | SameSite未設定/None = 脆弱 |

### Files to Create

| File | Description |
|------|-------------|
| plugins/redteam-core/skills/generate-e2e/templates/csrf.spec.ts.tmpl | CSRF専用テストテンプレート |

### Template Variables (Additional)

| Variable | Description | Example |
|----------|-------------|---------|
| {{VULN_ID}} | 脆弱性ID | CSRF-001 |
| {{CSRF_TYPE}} | CSRFタイプ | csrf-token-missing |
| {{ENDPOINT}} | テスト対象エンドポイント | /profile/update |
| {{METHOD}} | HTTPメソッド | POST / PUT / DELETE |
| {{AUTH_ENDPOINT}} | 認証エンドポイント | /login |
| {{AUTH_EMAIL}} | 認証用メールアドレス | test@example.com |
| {{AUTH_PASSWORD}} | 認証用パスワード | password |

### Output Example

```typescript
// csrf.spec.ts (generated)
import { test, expect } from '@playwright/test';

test.describe('CSRF Security Tests', () => {
  test('CSRF-001: Token missing at /profile/update', async ({ page, request }) => {
    // Authenticate first
    await page.goto('/login');
    await page.fill('#email', '{{AUTH_EMAIL}}');
    await page.fill('#password', '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    // Send POST without CSRF token
    const response = await request.post('/profile/update', {
      data: { name: 'Test' },
    });

    // If 200, CSRF vulnerability exists
    expect(response.status()).toBe(200);
  });
});
```

### References

- [OWASP CSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [Playwright API Testing](https://playwright.dev/docs/api-testing)

## Test List

### TODO

### WIP

### DONE
- [x] TC-01: [正常系] csrf-token-missing検出結果からテスト生成 (TC-01a~01d)
- [x] TC-02: [正常系] csrf-protection-disabled検出結果からテスト生成 (TC-02a)
- [x] TC-03: [正常系] samesite-cookie-missing検出結果からテスト生成 (TC-03a~03b)
- [x] TC-04: [正常系] 認証付きエンドポイントのテスト生成 (TC-04a~04b)
- [x] TC-05: [境界値] CSRF脆弱性0件時の処理 (TC-05a)
- [x] TC-06: [エッジケース] 複数HTTPメソッド対応 (TC-06a~06b)
- [x] TC-07: [異常系] 不正なCSRFタイプ指定時のエラー (TC-07a~07b)

## Notes

- 依存: #22 e2e-generator-base (完了)、#23 e2e-xss (完了)
- 検証タイプ: トークン欠如、保護無効化、SameSite Cookie
- 認証: テスト実行には事前認証が必要なケースあり
