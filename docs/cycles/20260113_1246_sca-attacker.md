# Cycle: sca-attacker

| Item | Value |
|------|-------|
| Issue | #40 |
| Phase | DONE |
| Created | 2026-01-13 12:46 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |

## Goal

依存関係ファイルを解析し、OSV APIで脆弱性を検出するエージェントを実装する。

## Background

From Issue #40:
- 依存関係ファイル (package.json, composer.json, requirements.txt等) を解析
- OSV API で脆弱性を検出
- 外部診断指摘の20%をカバー

## Scope

From Issue #40:
- [ ] 依存関係ファイル解析
- [ ] OSV API連携
- [ ] 脆弱性検出・レポート出力

## PLAN

### Background

外部診断で必ず指摘される「依存ライブラリのCVE」をカバーするため、OSV APIを利用した静的解析エージェントを実装する。

### Design

#### Detection Targets

| File | Ecosystem | Parse Method |
|------|-----------|--------------|
| package.json | npm | JSON parse, dependencies/devDependencies |
| package-lock.json | npm | JSON parse, packages |
| composer.json | Packagist | JSON parse, require/require-dev |
| composer.lock | Packagist | JSON parse, packages |
| requirements.txt | PyPI | Line parse, package==version |
| Pipfile.lock | PyPI | JSON parse, default/develop |
| Gemfile.lock | RubyGems | Text parse, gem名 (version) |
| go.mod | Go | Text parse, require lines |

#### OSV API Integration

- Endpoint: `POST https://api.osv.dev/v1/querybatch`
- Request Format:
  ```json
  {
    "queries": [
      { "package": { "name": "lodash", "ecosystem": "npm" }, "version": "4.17.0" }
    ]
  }
  ```
- Response: vulns array with CVE/GHSA IDs

#### Output Format

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "agent": "sca-attacker"
  },
  "vulnerabilities": [
    {
      "id": "SCA-001",
      "type": "vulnerable-dependency",
      "vulnerability_class": "vulnerable-dependency",
      "cwe_id": "CWE-1395",
      "severity": "high",
      "file": "package.json",
      "package": "lodash",
      "version": "4.17.0",
      "ecosystem": "npm",
      "osv_ids": ["GHSA-xxxx", "CVE-2021-xxxx"],
      "description": "Known vulnerability in lodash 4.17.0",
      "remediation": "Upgrade to lodash >= 4.17.21"
    }
  ],
  "summary": {
    "total": 1,
    "critical": 0,
    "high": 1,
    "medium": 0,
    "low": 0
  }
}
```

#### Workflow

1. **Find Files**: Glob for dependency files
2. **Parse Dependencies**: Extract package/version pairs
3. **Query OSV API**: Batch query for vulnerabilities
4. **Map Severity**: OSV severity to critical/high/medium/low
5. **Generate Report**: Output JSON format

#### Severity Mapping

| OSV Severity | Output Severity |
|--------------|-----------------|
| CRITICAL | critical |
| HIGH | high |
| MODERATE/MEDIUM | medium |
| LOW | low |
| Unknown (CVSS >= 9.0) | critical |
| Unknown (CVSS >= 7.0) | high |
| Unknown (CVSS >= 4.0) | medium |
| Unknown (CVSS < 4.0) | low |

#### HTTP Execution

- `allowed-tools: Read, Grep, Glob, Bash`
- HTTP via: `curl` command in Bash tool
- Example: `curl -s -X POST https://api.osv.dev/v1/querybatch -d '{"queries":[...]}'`

#### Version Resolution Strategy

| Pattern | Strategy |
|---------|----------|
| `1.0.0` (exact) | Use directly |
| `^1.0.0`, `~1.0.0`, `>=1.0.0` | Extract base version (1.0.0) |
| `*`, `latest` | Skip with warning |
| Lock file available | Prefer lock file version |

**Priority**: lock file > exact version > range base

#### Fallback Strategy

1. OSV API timeout (10s) → Retry once
2. OSV API error → Report as "api-unavailable", continue scan
3. Offline mode → Not supported (require API)

#### Known Limitations

- Transitive dependencies: Not supported in v1 (Phase 1: direct only)
- Private registries: Not supported
- devDependencies: Reported with `dev: true` flag

#### CWE/OWASP Mapping

| Type | CWE | OWASP |
|------|-----|-------|
| Vulnerable Dependency | CWE-1395 | A06:2021 Vulnerable and Outdated Components |

### Files

```
plugins/redteam-core/agents/
└── sca-attacker.md       # 新規作成

scripts/
└── test-sca-attacker.sh  # テストスクリプト
```

## Test List

### TODO

#### 正常系 - ファイル解析
- [ ] TC-02: package.json - devDependencies解析
- [ ] TC-03: package-lock.json - packages解析
- [ ] TC-04: composer.json - require解析
- [ ] TC-05: composer.lock - packages解析
- [ ] TC-06: requirements.txt - package==version形式
- [ ] TC-07: Pipfile.lock - default/develop解析
- [ ] TC-08: Gemfile.lock - gem名 (version)形式
- [ ] TC-09: go.mod - require行解析

#### 正常系 - OSV API
- [ ] TC-10: 脆弱なパッケージ検出 (lodash 4.17.0)
- [ ] TC-11: 安全なパッケージ (脆弱性なし)
- [ ] TC-12: バッチクエリ (複数パッケージ)

#### 境界値
- [ ] TC-13: バージョン形式 - ^1.0.0 (caret) → base抽出
- [ ] TC-14: バージョン形式 - ~1.0.0 (tilde) → base抽出
- [ ] TC-15: バージョン形式 - >=1.0.0 (range) → base抽出
- [ ] TC-16: バージョン形式 - 1.0.0 (exact) → そのまま使用
- [ ] TC-17: バージョン形式 - *, latest → skip with warning
- [ ] TC-18: 大量パッケージ (100+依存)
- [ ] TC-19: lock file優先 (package.json vs package-lock.json)

#### エッジケース
- [ ] TC-20: 空のdependencies
- [ ] TC-21: 依存関係ファイルなし
- [ ] TC-22: 複数ファイル混在 (package.json + composer.json)
- [ ] TC-23: devDependencies flagging

#### 異常系
- [ ] TC-24: 不正なJSON形式
- [ ] TC-25: バージョン情報なし
- [ ] TC-26: OSV API タイムアウト → リトライ
- [ ] TC-27: OSV API エラー → api-unavailable報告

#### 外部依存
- [ ] TC-28: OSV API 実際の脆弱性検出
- [ ] TC-29: Severity Mapping (critical/high/medium/low)

### WIP

### DONE

- [x] TC-01: package.json - dependencies解析

## REVIEW

### quality-gate Results

| Reviewer | Score | Verdict |
|----------|-------|---------|
| Security | 35 | PASS |
| Guidelines | 15 | PASS |
| Correctness | 62 | WARN |
| Performance | 42 | PASS |

**Total**: WARN (max score 62)

### Findings Summary

| 指摘 | 対応 |
|------|------|
| `dev` フィールド未記載 | **修正済** (L86) |
| バッチサイズ制限未定義 | **修正済** (L36) |
| CWE-937追加検討 | **修正済** (L118-121) |
| OSV API response詳細化 | Issue #46 |
| Exponential backoff | Issue #46 |
| 並列処理・キャッシュ | Issue #46 |

**Decision**: 3件修正完了、3件はIssue #46へ。COMMITへ進行。

## Notes

- v4.0 マイルストーン
- 対象ファイル: package.json, composer.json, requirements.txt, Gemfile.lock, go.mod
