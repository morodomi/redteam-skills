# Cycle: sca-attacker-v4

| Item | Value |
|------|-------|
| Issue | #46 |
| Phase | DONE |
| Created | 2026-01-15 11:16 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |

## Goal

sca-attackerのv4.0改善。Exponential backoffとOSV API response format詳細化。

## Background

From Issue #46:
- quality-gate reviewで検出された改善点
- Correctness 62 (WARN), Performance 42 (PASS)

## Scope

From Issue #46:
- [ ] OSV API response format詳細化
- [ ] Exponential backoff実装（3回リトライ: 2s, 4s, 8s）

## PLAN

### Background

sca-attacker (#40) 実装時のquality-gateで検出された改善点を対応。

### Design

#### 1. OSV API Response Format詳細化

現状 (line 35):
```
- Response: vulns array with CVE/GHSA IDs
```

改善後:
```json
{
  "results": [
    {
      "vulns": [
        {
          "id": "GHSA-xxxx-xxxx-xxxx",
          "summary": "Prototype Pollution in lodash",
          "severity": [{ "type": "CVSS_V3", "score": "7.5" }],
          "affected": [{ "package": {...}, "ranges": [...] }],
          "references": [{ "type": "ADVISORY", "url": "..." }]
        }
      ]
    }
  ]
}
```

#### 2. Exponential Backoff実装

現状 (line 61):
```
1. OSV API timeout (10s) → Retry once
```

改善後:
```
1. OSV API timeout (10s) → Exponential backoff (3回: 2s, 4s, 8s)
```

| Attempt | Delay | Total Wait |
|---------|-------|------------|
| 1st retry | 2s | 2s |
| 2nd retry | 4s | 6s |
| 3rd retry | 8s | 14s |

### Files

```
plugins/redteam-core/agents/
└── sca-attacker.md    # 更新

scripts/
└── test-sca-attacker-v4.sh  # 新規
```

## Test List

### TODO

#### OSV API Response Format
- [ ] TC-01: Response Formatセクションに詳細JSON構造がある
- [ ] TC-02: vulnsオブジェクトのフィールド（id, summary, severity, affected）が記載
- [ ] TC-03: severityの構造（type, score）が記載

#### Exponential Backoff
- [ ] TC-04: Fallback StrategyにExponential backoffが記載
- [ ] TC-05: リトライ回数が3回と記載
- [ ] TC-06: リトライ間隔が2s, 4s, 8sと記載

#### 既存機能維持
- [ ] TC-07: 既存のtimeout 10sが維持
- [ ] TC-08: 既存のapi-unavailableフォールバックが維持

### WIP

(なし)

### DONE

- [x] TC-01: Response Formatセクションに詳細JSON構造がある
- [x] TC-02: vulnsオブジェクトのフィールド（id, summary, severity, affected）が記載
- [x] TC-03: severityの構造（type, score）が記載
- [x] TC-04: Fallback StrategyにExponential backoffが記載
- [x] TC-05: リトライ回数が3回と記載
- [x] TC-06: リトライ間隔が2s, 4s, 8sと記載
- [x] TC-07: 既存のtimeout 10sが維持
- [x] TC-08: 既存のapi-unavailableフォールバックが維持

## REVIEW

### Quality Gate Results

| Reviewer | Score | Judgment |
|----------|-------|----------|
| correctness | 35 | PASS |
| performance | 32 | PASS |
| security | 25 | PASS |
| guidelines | 25 | PASS |

**Max Score: 35 → PASS**

### Notes

- OSV API Response Formatは「期待する出力形式」として記載
- Exponential backoffは業界標準のパターン
- セキュリティ面での懸念なし

## Notes

- v4.0 マイルストーン
- 関連: #40 sca-attacker (完了), #41 sca-scan (完了)
