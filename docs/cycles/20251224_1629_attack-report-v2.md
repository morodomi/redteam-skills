# TDD Cycle: attack-report-v2

## Overview

| Item | Value |
|------|-------|
| Feature | attack-report スキル拡張（CVSS 4.0対応） |
| Issue | #9 |
| Phase | DONE |
| Started | 2024-12-24 16:29 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

既存のattack-reportスキル（Issue #6）を拡張し、CVSS 4.0スコア算出とOWASP/CWEリンク生成機能を追加する。

### MVP対象
- CVSS 4.0 Base Score算出
- OWASP/CWEリンク自動付与
- 優先度付け（CVSS順）

### 対象外（将来）
- EPSS統合
- Threat Metrics（実悪用情報）
- HTML/PDF出力
- security-scan typeフィールド追加 (Issue #16)

## Background

### Issue #6 vs Issue #9

| 機能 | Issue #6 | Issue #9 |
|------|----------|----------|
| Markdown出力 | Done | - |
| 重大度分類 | Done | - |
| CVSS 4.0スコア | - | NEW |
| OWASP/CWEリンク | - | NEW |
| 優先度ソート | - | NEW |

### CVSS 4.0 Base Metrics

| Metric | Values |
|--------|--------|
| Attack Vector (AV) | Network/Adjacent/Local/Physical |
| Attack Complexity (AC) | Low/High |
| Attack Requirements (AT) | None/Present |
| Privileges Required (PR) | None/Low/High |
| User Interaction (UI) | None/Passive/Active |
| Vulnerable System (VC/VI/VA) | None/Low/High |
| Subsequent System (SC/SI/SA) | None/Low/High |

## References

- [CVSS v4.0 Specification](https://www.first.org/cvss/v4-0/specification-document)
- [CVSS 4.0 Calculator](https://www.first.org/cvss/calculator/4-0)
- [Anthropic Security Review](https://github.com/anthropics/claude-code-security-review)

## PLAN

### スコープ

既存attack-reportスキルのreference.mdを拡張。CVSS 4.0スコアとOWASP/CWEリンクを追加。

### ファイル構成

```
plugins/redteam-core/skills/attack-report/
├── SKILL.md        # 出力形式を更新
└── reference.md    # CVSS/CWE/OWASPマッピング追加
```

### CVSS 4.0 Vector Mapping

| Vulnerability Type | CVSS 4.0 Vector | Score |
|-------------------|-----------------|-------|
| sql-injection | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H/SC:N/SI:N/SA:N | 9.3 |
| xss-reflected | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:A/VC:L/VI:L/VA:N/SC:L/SI:L/SA:N | 5.1 |
| xss-stored | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:P/VC:H/VI:H/VA:N/SC:L/SI:L/SA:N | 7.2 |
| hardcoded-credentials | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 |
| missing-auth | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 |
| broken-access-control | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 8.5 |
| mass-assignment | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 8.5 |
| bola | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:N/VC:H/VI:L/VA:N/SC:N/SI:N/SA:N | 7.1 |
| rate-limiting-missing | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:N/VI:N/VA:L/SC:N/SI:N/SA:N | 5.3 |
| excessive-data-exposure | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:N/VC:H/VI:N/VA:N/SC:N/SI:N/SA:N | 6.5 |

### CWE/OWASP Mapping

| Type | CWE | OWASP |
|------|-----|-------|
| sql-injection | CWE-89 | A03:2021 |
| xss-reflected | CWE-79 | A03:2021 |
| xss-stored | CWE-79 | A03:2021 |
| hardcoded-credentials | CWE-798 | A07:2021 |
| missing-auth | CWE-306 | A07:2021 |
| broken-access-control | CWE-862 | A01:2021 |
| mass-assignment | CWE-915 | API3:2023 |
| bola | CWE-639 | API1:2023 |
| rate-limiting-missing | CWE-770 | API4:2023 |
| excessive-data-exposure | CWE-200 | API3:2023 |

### リンクテンプレート

```
CWE: https://cwe.mitre.org/data/definitions/{ID}.html
OWASP Top 10: https://owasp.org/Top10/2021/A{XX}_{YYYY}-{Name}/
OWASP API: https://owasp.org/API-Security/editions/2023/en/0xa{X}-{kebab-case-name}/
```

例:
- CWE-89 → https://cwe.mitre.org/data/definitions/89.html
- A03:2021 → https://owasp.org/Top10/2021/A03_2021-Injection/
- API1:2023 → https://owasp.org/API-Security/editions/2023/en/0xa1-broken-object-level-authorization/

### 出力形式（拡張）

```markdown
#### [SQLI-001] SQL Injection
- **CVSS 4.0**: 9.3 (Critical)
- **Vector**: `CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H/SC:N/SI:N/SA:N`
- **File**: app/Controllers/UserController.php:45
- **Agent**: injection-attacker
- **References**:
  - [CWE-89](https://cwe.mitre.org/data/definitions/89.html)
  - [OWASP A03:2021](https://owasp.org/Top10/2021/A03_2021-Injection/)
- **Description**: User input concatenated in SQL query
- **Remediation**: Use parameterized queries or ORM
```

### 優先度ソート

1. CVSSスコア降順
2. 同スコアの場合: Critical > High > Medium > Low

## Test List

### DONE
- [x] TC-01: reference.mdにCVSS 4.0 Vector Mappingセクションが存在する
- [x] TC-02: reference.mdにCWE/OWASP Mappingセクションが存在する
- [x] TC-03: reference.mdにリンクテンプレートが存在する
- [x] TC-04: SKILL.mdの出力形式にCVSSスコアが含まれる
- [x] TC-05: SKILL.mdの出力形式にReferencesセクションが含まれる
- [x] TC-06: SKILL.mdにCVSS順ソートの説明が存在する
- [x] TC-07: 主要脆弱性タイプ（SQLi, XSS, Auth, API）のCVSSマッピングが定義されている
- [x] TC-08: CWE/OWASPリンクが正しい形式で定義されている

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | CVSS/CWEマッピング設計、Test List作成 |
| RED | Done | 8テスト作成、7失敗確認（TC-06既存通過） |
| GREEN | Done | reference.md/SKILL.md更新、全テスト成功 |
| REFACTOR | Done | リファクタリング不要（構造クリーン） |
| REVIEW | Done | テスト全PASS、code-review完了（拡張=#10/#16対象） |
| COMMIT | Done | c7c7722 |
