# TDD Cycle: vulnerability-type-field

## Overview

| Item | Value |
|------|-------|
| Feature | security-scan: vulnerability type フィールド追加 |
| Issue | #16 |
| Created | 2025-12-25 11:56 |
| Status | INIT |

## Goal

security-scanの出力にtype/subtypeフィールドを追加し、attack-reportのCVSSマッピング精度を向上させる。

## Background

- 現状: agent名から脆弱性タイプを推測
- 課題: CVSSマッピングが不正確
- 将来: EPSS統合に必要

## Current vs Expected

### Current
```json
{
  "agent": "injection-attacker",
  "id": "SQLI-001",
  "severity": "high"
}
```

### Expected
```json
{
  "agent": "injection-attacker",
  "id": "SQLI-001",
  "type": "sql-injection",
  "subtype": "union-based",
  "severity": "high"
}
```

## Environment

| Item | Value |
|------|-------|
| Project Type | Claude Code Plugin |
| Distribution | Markdown-based agents/skills |
| Testing | Shell scripts (scripts/test-*.sh) |

## Affected Files

- plugins/redteam-core/agents/*.md (全attacker)
- plugins/redteam-core/skills/security-scan/reference.md
- plugins/redteam-core/skills/attack-report/reference.md

## PLAN v3 (Final)

### 設計変更の要点
- **既存`type`フィールドを維持**（破壊的変更を回避）
- **新規`vulnerability_class`フィールドを追加**（カテゴリ分類）
- `subtype`は不要（既存typeがその役割）

### スキーマ設計

#### Before (現状)
```json
{
  "agent": "injection-attacker",
  "id": "SQLI-001",
  "type": "union-based",
  "severity": "critical"
}
```

#### After (v2.0)
```json
{
  "metadata": { "schema_version": "2.0" },
  "details": [{
    "agent": "injection-attacker",
    "id": "SQLI-001",
    "type": "union-based",
    "vulnerability_class": "sql-injection",
    "cwe_id": "CWE-89",
    "severity": "critical"
  }]
}
```

### vulnerability_class マッピング

| Agent | type (既存維持) | vulnerability_class (新規) | CWE |
|-------|----------------|---------------------------|-----|
| injection-attacker | union-based, error-based, boolean-blind | sql-injection | CWE-89 |
| xss-attacker | reflected, stored, dom-based | xss | CWE-79 |
| ssrf-attacker | ssrf, blind-ssrf, partial-ssrf | ssrf | CWE-918 |
| auth-attacker | hardcoded-credentials | hardcoded-credentials | CWE-798 |
| auth-attacker | missing-auth | missing-authentication | CWE-306 |
| auth-attacker | broken-access-control | broken-access-control | CWE-862 |
| api-attacker | mass-assignment | mass-assignment | CWE-915 |
| api-attacker | bola | bola | CWE-639 |
| file-attacker | path-traversal | path-traversal | CWE-22 |
| file-attacker | lfi | local-file-inclusion | CWE-98 |
| file-attacker | arbitrary-file-upload | unrestricted-file-upload | CWE-434 |
| crypto-attacker | weak-hash | weak-hash | CWE-328 |
| crypto-attacker | weak-crypto | weak-crypto | CWE-327 |
| crypto-attacker | debug-enabled | debug-enabled | CWE-489 |
| error-attacker | empty-catch | empty-catch | CWE-390 |
| error-attacker | fail-open | fail-open | CWE-636 |

### 変更ファイル（9個）
1. security-scan/reference.md - スキーマv2.0、vulnerability_class/cwe_id追加
2-9. 8 x agents/*.md - Output Formatにvulnerability_class/cwe_id追加

### Out of Scope (別Issue)
- #19 csrf-attacker
- #20 command-injection追加

## Test List

### スキーマ定義
- [x] TC-01: reference.mdにschema_version定義あり
- [x] TC-02: detailsにvulnerability_class必須フィールドあり
- [x] TC-03: detailsにcwe_id任意フィールドあり
- [x] TC-04: 既存typeフィールドが維持されている

### 各エージェント
- [x] TC-05: injection-attackerにvulnerability_class定義あり
- [x] TC-06: xss-attackerにvulnerability_class定義あり
- [x] TC-07: ssrf-attackerにvulnerability_class定義あり
- [x] TC-08: auth-attackerにvulnerability_class定義あり
- [x] TC-09: api-attackerにvulnerability_class定義あり
- [x] TC-10: file-attackerにvulnerability_class定義あり
- [x] TC-11: crypto-attackerにvulnerability_class定義あり
- [x] TC-12: error-attackerにvulnerability_class定義あり

### 後方互換性
- [x] TC-13: 全エージェントで既存typeフィールドが維持
- [x] TC-14: schema_version未指定時の動作が定義されている

## Phase Log

| Phase | Status | Notes |
|-------|--------|-------|
| INIT | Done | Cycle doc作成 |
| PLAN v2 | Done | スコープ縮小、CWE準拠命名 |
| plan-review v2 | Done | Score 85 BLOCK → フィールド名衝突 |
| PLAN v3 | Done | vulnerability_class新規追加、既存type維持 |
| plan-review v3 | Done | 簡易評価 PASS |
| RED | Done | 15テスト作成、2 PASS / 13 FAIL |
| GREEN | Done | reference.md + 8エージェント更新、15 PASS |
| REFACTOR | Done | Test List更新（TODO→DONE） |
| REVIEW | Done | quality-gate PASS (全15) |
| COMMIT | - | |
