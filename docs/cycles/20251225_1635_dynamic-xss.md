# Cycle: dynamic-xss

## Metadata

| Item | Value |
|------|-------|
| Feature | XSS動的検証 |
| Issue | #17 |
| Status | DONE |
| Created | 2025-12-25 16:35 |

## Environment

| Item | Version |
|------|---------|
| Node | v22.17.0 |

## Goal

XSS脆弱性の動的検証機能を実装する。
静的解析で検出したXSS脆弱性に対し、実際にペイロードを送信して検証する。

## Scope

| Feature | Description | Status |
|---------|-------------|--------|
| Reflected XSS検証 | ペイロード挿入→レスポンスで反射確認 | In Scope |
| DOM XSS検証 | JavaScriptコンテキストでの検証 | **Out of Scope** |

### Out of Scope理由

DOM XSSは動的検証に以下の理由で非対応:
- curl方式ではJavaScript実行不可
- ヘッドレスブラウザ必要（アーキテクチャ変更が必要）
- 静的解析（xss-attacker）で対応済み

## Dependencies

- #13 dynamic-testing（基盤）- 完了済み

## Design

### Agent Structure (dynamic-verifier.md)

```markdown
# Dynamic Verifier

## Common Settings（共通設定）
- Rate Limiting: 2秒間隔（SQLi/XSS統一）
- Max Requests: 50/session
- Timeout: 10秒
- URL Validation: localhost以外は確認

## Common Pre-processing（共通前処理）
- curl -i でヘッダ取得
- Content-Type判定
- リダイレクト追跡

## SQLi Verification（既存）
- Detection Target: SQLi
- Patterns: SQL error messages
- Payloads: ', 1' OR '1'='1, etc.

## XSS Verification（新規追加）
- Detection Target: Reflected XSS
- Patterns: Payload reflection detection
- Payloads: <script>, <img onerror>, etc.
```

### Option Flag

```yaml
flag: --enable-dynamic-xss
default: false  # 明示的に有効化が必要
requires: --target  # URL指定必須
```

### XSS Payloads

```yaml
xss_payloads:
  non_destructive:
    - "<script>XSS-{uuid}</script>"           # Basic script tag
    - "<img src=x onerror=XSS-{uuid}>"        # Event handler
    - "'\"><script>XSS-{uuid}</script>"       # Attribute breakout

  # Forbidden payloads (never use)
  forbidden:
    - "document.cookie"      # Cookie theft
    - "document.location"    # Redirect
    - "fetch("               # External request
    - "XMLHttpRequest"       # External request
    - "eval("                # Code execution
    - "window.location"      # Redirect
```

### Encoding Detection Patterns

```yaml
encoding_patterns:
  html_entity:
    - "&lt;" → "<"
    - "&gt;" → ">"
    - "&quot;" → '"'
    - "&#60;" → "<"
    - "&#x3C;" → "<"

  url_encoding:
    - "%3C" → "<"
    - "%3E" → ">"
    - "%22" → '"'

  javascript_encoding:
    - "\\x3C" → "<"
    - "\\u003C" → "<"
```

### Verification Logic

```
Common Pre-processing (SQLi/XSS共通):
1. curl -i でリクエスト送信（ヘッダ含む）
2. Content-Type解析:
   - text/html* → 検証続行
   - application/json, text/xml等 → スキップ
   - charset指定は無視（text/html; charset=utf-8 → OK）
3. リダイレクト(3xx) → -L フラグで追跡（最大5回）

XSS Verification:
4. ペイロードをパラメータに挿入
5. レスポンスボディで検索:
   - Exact match (unescaped) → confirmed
   - Encoded match (&lt;, %3C等) → not_vulnerable
   - No match → not_vulnerable
6. Rate limit: 2秒間隔、最大3ペイロード/エンドポイント
```

### Verification Result Definition

| Result | SQLi | XSS |
|--------|------|-----|
| confirmed | SQLエラーメッセージ検出 | ペイロードがエスケープなしで反射 |
| not_vulnerable | エラーなし | エンコード済み or 反射なし |
| inconclusive | タイムアウト | タイムアウト |
| skipped | 到達不能 | 到達不能 or Content-Type非対象 |

### Safety Measures

| Risk | Mitigation |
|------|------------|
| Production attack | `--target` + `--enable-dynamic-xss` required |
| Unauthorized access | localhost以外は確認プロンプト |
| Destructive payload | Non-destructive only (forbidden list) |
| Overload | 2秒間隔、最大3ペイロード/エンドポイント |

## Files to Change

| File | Change |
|------|--------|
| `agents/dynamic-verifier.md` | XSS検証ロジック追加 |
| `skills/security-scan/reference.md` | XSS動的検証の説明追加 |
| `skills/security-scan/SKILL.md` | `--enable-dynamic-xss`フラグ追加 |
| `scripts/test-dynamic-testing.sh` | XSS検証テスト追加 |

## Acceptance Criteria

- [ ] XSSペイロード送信機能
- [ ] レスポンス解析（反射検出）
- [ ] 非破壊ペイロードのみ使用
- [ ] テスト作成

## Test List

### WIP

#### Payload Generation
- [ ] TC-01: XSSペイロード生成（UUID埋め込み）

### TODO
- [ ] TC-02: 禁止ペイロード検出（forbidden list）

#### HTTP Request
- [ ] TC-03: ペイロード付きリクエスト送信
- [ ] TC-04: Content-Type確認（text/html以外はスキップ）
- [ ] TC-05: タイムアウト処理（10秒）

#### Response Analysis
- [ ] TC-06: 反射検出（エスケープなし→confirmed）
- [ ] TC-07: HTMLエンコード検出（&lt;→not_vulnerable）
- [ ] TC-08: URLエンコード検出（%3C→not_vulnerable）
- [ ] TC-09: 反射なし検出（→not_vulnerable）

#### Flag Handling
- [ ] TC-10: `--enable-dynamic-xss`なしでスキップ
- [ ] TC-11: `--target`なしでエラー

#### Safety
- [ ] TC-12: Rate limiting（2秒間隔）
- [ ] TC-13: 最大3ペイロード/エンドポイント制限

## History

| Phase | Date | Notes |
|-------|------|-------|
| INIT | 2025-12-25 16:35 | Cycle開始 |
| PLAN | 2025-12-25 16:40 | 設計完了（plan-review BLOCK→修正済み） |
| PLAN | 2025-12-25 16:50 | WARN課題修正（セクション分離、Content-Type、rate limiting統一、result定義） |
| RED | 2025-12-25 17:00 | テスト作成完了（TC-15〜TC-27、11 FAIL確認） |
| GREEN | 2025-12-25 17:10 | 実装完了（27 passed, 0 failed） |
| REFACTOR | 2025-12-25 17:15 | Rate Limiting統一（sleep 1→2） |
| GREEN | 2025-12-25 17:20 | quality-gate WARN課題修正（UUID/Forbidden/IPv6） |
| REVIEW | 2025-12-25 17:25 | 品質検証完了（27 passed, 全課題対応済み） |
