# Cycle: xxe-attacker

| Item | Value |
|------|-------|
| Issue | #32 |
| Phase | DONE |
| Created | 2026-01-08 16:00 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |

## Goal

XML External Entity (XXE) Injection を検出するエージェントを新規作成する。

## Background

From Issue #32:
- 対象パターン: Classic XXE, Blind XXE, XXE DoS, SSRF via XXE
- OWASP: A05:2021 Security Misconfiguration
- CWE-611: Improper Restriction of XML External Entity Reference

## Scope

From Issue #32:
- [ ] agents/xxe-attacker.md 作成
- [ ] Framework別パターン定義
- [ ] 安全なパーサー設定のガイダンス
- [ ] テストスクリプト作成

## PLAN

### Design

```
xxe-attacker.md
├── Detection Targets (Classic/Blind/DoS/SSRF)
├── Framework Detection Patterns (PHP/Python/Java/Node.js)
├── Dangerous Patterns (正規表現)
├── Safe Patterns (誤検知除外)
├── Output Format (vulnerability_class: xxe)
└── Severity Criteria
```

### XXE Type Definitions

| Type | Description | Risk |
|------|-------------|------|
| classic-xxe | 外部エンティティによるファイル読み取り | High |
| blind-xxe | OOBデータ送信 | High |
| xxe-dos | Billion Laughs / Quadratic Blowup | Medium |
| ssrf-xxe | XXE経由のSSRF | High |

### Dangerous Patterns

| Language | Pattern | Risk |
|----------|---------|------|
| PHP | `simplexml_load_string($input)` | 外部エンティティ処理がデフォルト有効 |
| PHP | `loadXML($input, LIBXML_NOENT)` | LIBXML_NOENT で外部エンティティ展開 |
| Python | `lxml.etree.parse()` | resolve_entities=True時に危険 |
| Python | `xml.sax.parse()` | 外部エンティティ処理あり |
| Java | `DocumentBuilderFactory` | setFeatureなしで危険 |
| Java | `SAXParserFactory` | setFeatureなしで危険 |
| Node.js | `libxmljs.parseXml()` | 外部エンティティ処理あり |

NOTE: Python標準ElementTreeはXXE脆弱ではない。Node.js xml2jsもデフォルトで安全。

### Safe Patterns (除外)

| Language | Pattern | Reason |
|----------|---------|--------|
| PHP | `LIBXML_NOENT` なしの `loadXML` | 安全なデフォルト |
| PHP | `libxml_disable_entity_loader(true)` | PHP7.x以前で有効 |
| Python | `defusedxml` | 安全なXMLパーサー |
| Python | `xml.etree.ElementTree` | 標準ライブラリは安全 |
| Java | `setFeature("external-general-entities", false)` | 外部エンティティ無効化 |
| Node.js | `xml2js` | デフォルトで安全 |

### CWE/OWASP Mapping

| Reference | ID |
|-----------|---|
| CWE | CWE-611: Improper Restriction of XML External Entity Reference |
| OWASP | A05:2021 Security Misconfiguration |

### Files to Create/Modify

| File | Changes |
|------|---------|
| plugins/redteam-core/agents/xxe-attacker.md | 新規作成 |
| scripts/test-xxe-attacker.sh | テストスクリプト |

## Test List

### TODO

### WIP

### DONE
- [x] TC-01: [正常系] PHP simplexml XXE検出
- [x] TC-02: [正常系] PHP LIBXML_NOENT XXE検出
- [x] TC-03: [正常系] Python lxml XXE検出
- [x] TC-04: [正常系] Python xml.sax XXE検出
- [x] TC-05: [正常系] Java DocumentBuilderFactory XXE検出
- [x] TC-06: [正常系] Node.js libxmljs XXE検出
- [x] TC-07: [境界値] 安全なパターン除外（defusedxml等）
- [x] TC-08: [エッジケース] 複数言語混在
- [x] TC-09: [異常系] 対象ファイルなし

## REVIEW

### quality-gate Results

| Agent | Score | Status |
|-------|-------|--------|
| Correctness | 35 | PASS |
| Performance | 25 | PASS |
| Security | 15 | PASS |
| Guidelines | 25 | PASS |

**Max Score: 35 (PASS)**

### Optional Improvements (Applied)

- [x] Java XMLReader パターン追加
- [x] Go encoding/xml パターン追加
- [x] PHP 8.x 互換性ドキュメント改善
- [x] より限定的な正規表現（`load\s*\(` → `->load\s*\(`）

## Notes

- v2.2 マイルストーン
- XMLパーサーの安全設定ガイダンスを含む
