# TDD Cycle: xss-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | xss-attacker Reflected XSS検出 |
| Issue | #4 |
| Phase | DONE |
| Started | 2024-12-24 13:31 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

Reflected XSS脆弱性を検出するエージェントを実装する。

### MVP対象
- Reflected XSS
- 基本的なサニタイズ不備検出

## PLAN

### スコープ

xss-attackerエージェントファイルの作成。静的解析によるReflected XSS検出。

### ファイル構成

```
plugins/redteam-core/agents/
└── xss-attacker.md    # XSS検出エージェント定義
```

### エージェント設計

```yaml
name: xss-attacker
description: XSS検出エージェント。静的解析でReflected XSS脆弱性を検出。
allowed-tools: Read, Grep, Glob
```

### 検出対象（MVP）

| Type | Description | Pattern |
|------|-------------|---------|
| Reflected XSS | ユーザー入力の直接出力 | エスケープなしのecho/print |
| Sanitization Missing | サニタイズ不備 | htmlspecialchars等の欠如 |

### フレームワーク別検出パターン

| Framework | Vulnerable Pattern | Safe Pattern |
|-----------|-------------------|--------------|
| Laravel | `{!! $input !!}`, `echo $input` | `{{ $input }}`, `e($input)` |
| Django | `\|safe`, `mark_safe()` | 自動エスケープ（デフォルト） |
| Flask | `\|safe`, `Markup()` | 自動エスケープ（Jinja2） |
| Express | `res.send(input)`, `innerHTML=` | テンプレートエンジン使用 |

### 危険パターン（Grep対象）

```yaml
patterns:
  # PHP/Laravel
  - 'echo\s+\$'
  - 'print\s+\$'
  - '\{\!\!\s*\$.*\!\!\}'
  - '->with\s*\([^)]*\$_'

  # Python/Django/Flask
  - '\|safe'
  - 'mark_safe\s*\('
  - 'Markup\s*\('

  # Node.js/Express
  - 'res\.send\s*\([^)]*\+'
  - 'innerHTML\s*='
  - 'document\.write\s*\('
```

### 出力形式

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "agent": "xss-attacker"
  },
  "vulnerabilities": [
    {
      "id": "XSS-001",
      "type": "reflected",
      "severity": "high",
      "file": "resources/views/user.blade.php",
      "line": 23,
      "code": "{!! $request->input('name') !!}",
      "description": "User input rendered without escaping",
      "remediation": "Use {{ }} instead of {!! !!} for auto-escaping"
    }
  ],
  "summary": {
    "total": 1,
    "critical": 0,
    "high": 1,
    "medium": 0,
    "low": 0
  }
}
```

### 重大度基準

| Severity | Criteria |
|----------|----------|
| critical | ユーザー入力が直接HTML出力 + 認証なし + Cookie/Session操作可能 |
| high | ユーザー入力が直接HTML出力 + 認証なし |
| medium | ユーザー入力が直接HTML出力 + 認証あり |
| low | 潜在的なXSSパターン + 部分的なサニタイズ |

### CWE/OWASP マッピング

| Reference | ID |
|-----------|-----|
| CWE | CWE-79: Cross-site Scripting (XSS) |
| OWASP Top 10 | A03:2021 Injection |

## Test List

### DONE
- [x] TC-01: xss-attacker.md が存在する
- [x] TC-02: YAML frontmatter（name, description, allowed-tools）が存在する
- [x] TC-03: 検出対象セクション（Reflected XSS, Sanitization）が存在する
- [x] TC-04: フレームワーク別検出パターン表が存在する
- [x] TC-05: 危険パターン（Grepパターン）が定義されている
- [x] TC-06: 出力形式（JSONスキーマ）が存在する
- [x] TC-07: 重大度基準が存在する
- [x] TC-08: CWE/OWASPマッピングが存在する

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | エージェント設計、Test List作成 |
| RED | Done | 8テスト作成、全失敗確認 |
| GREEN | Done | xss-attacker.md作成、全テスト成功 |
| REFACTOR | Done | リファクタリング不要（構造クリーン） |
| REVIEW | Done | テスト全PASS、code-review完了（Critical=v0.2.0対象） |
| COMMIT | Done | 71b5e88 |

## References

- [OWASP XSS](https://owasp.org/www-community/attacks/xss/)
- [CWE-79: Cross-site Scripting](https://cwe.mitre.org/data/definitions/79.html)
