# TDD Cycle: csrf-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | csrf-attacker: CSRF検出エージェント |
| Issue | #19 |
| Created | 2025-12-25 15:53 |
| Status | DONE |

## Goal

CWE-352 (Cross-Site Request Forgery) 検出エージェントを実装する。

## Background

- CWE Top 25 2025: #3位（高優先度）
- 現状: CSRF検出エージェントなし
- OWASP A01:2025 Broken Access Controlに該当

## Scope

- [ ] csrf-attacker.md 新規作成
- [ ] CSRFトークン欠如検出
- [ ] SameSite Cookie未設定検出
- [ ] Refererチェック不備検出
- [ ] CVSS/CWE/OWASPマッピング追加

## Environment

| Item | Value |
|------|-------|
| Project Type | Claude Code Plugin |
| Distribution | Markdown-based agents/skills |
| Testing | Shell scripts (scripts/test-*.sh) |

## PLAN

### 設計方針

1. **新規エージェント**: `csrf-attacker.md` を新規作成
2. **既存パターン準拠**: auth-attacker等と同じ構造
3. **フレームワーク対応**: Laravel/Django/Flask/Express/Rails
4. **attack-report連携**: CVSS/CWE/OWASPマッピング追加

### 検出対象

| Type | Description | Detection |
|------|-------------|-----------|
| csrf-token-missing | CSRFトークン欠如 | フォームに@csrf/csrf_token等なし |
| csrf-protection-disabled | CSRF保護の意図的無効化 | @csrf_exempt, skip_verify等 |
| samesite-cookie-missing | SameSite Cookie未設定 | SameSite=None or 未指定 |
| state-change-unprotected | 状態変更操作の保護不備 | POST/PUT/DELETEにCSRF保護なし |

### フレームワーク別パターン

| Framework | Dangerous Pattern | Safe Pattern |
|-----------|-------------------|--------------|
| Laravel | Form without @csrf | @csrf directive |
| Django | @csrf_exempt decorator | CsrfViewMiddleware |
| Flask | WTForms without csrf | CSRFProtect, validate_csrf |
| Express | No csurf middleware | csurf(), csrf() |
| Rails | skip_before_action :verify_authenticity_token | protect_from_forgery |

### CVSSベクター

```
csrf: CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:A/VC:N/VI:L/VA:N/SC:N/SI:N/SA:N (5.1)
```
- UI:A (被害者の操作が必要)
- VI:L (整合性への低〜中程度の影響: 単一アクション実行)

※ CSRFは被害者の操作が必要かつ、影響は特定アクションに限定されるためVI:L

### Severity Criteria

| Severity | Criteria |
|----------|----------|
| critical | 公開エンドポイント + 状態変更操作 + CSRF保護完全欠如 |
| high | 認証後エンドポイント + 重要操作（パスワード変更等）+ CSRF保護なし |
| medium | SameSite Cookie未設定 + セッション管理に依存 |
| low | CSRF保護の意図的無効化（テスト用等）、潜在的リスク |

### Output Format詳細

```json
{
  "id": "CSRF-001",
  "type": "csrf-token-missing",
  "vulnerability_class": "csrf",
  "cwe_id": "CWE-352",
  "severity": "high",
  "file": "app/Http/Controllers/UserController.php",
  "line": 45,
  "code": "<form method=\"POST\">",
  "description": "Form submission without CSRF token",
  "remediation": "Add @csrf directive to form"
}
```

### 変更ファイル

1. `plugins/redteam-core/agents/csrf-attacker.md` (新規)
   - Detection Targets: 4タイプ
   - Framework Detection Patterns: 5フレームワーク
   - Dangerous Patterns: YAML形式
   - Output Format: CSRF-xxx形式
   - CWE/OWASP Mapping

2. `plugins/redteam-core/skills/attack-report/reference.md`
   - CVSS表: csrf追加（Score 5.1）
   - Agent to Type Mapping: csrf-attacker追加
   - CWE/OWASP表: csrf | CWE-352 | A01:2025

3. `scripts/test-csrf-attacker.sh` (新規)

### 参照

- [CWE-352](https://cwe.mitre.org/data/definitions/352.html)
- [OWASP CSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)

## Test List

### csrf-attacker.md
- [ ] TC-01: ファイルが存在する
- [ ] TC-02: YAML frontmatter（name, description, allowed-tools）がある
- [ ] TC-03: Detection Targetsセクションがある
- [ ] TC-04: csrf-token-missingパターンがある
- [ ] TC-05: csrf-protection-disabledパターンがある
- [ ] TC-06: Framework Detection Patterns表がある
- [ ] TC-07: Dangerous Patternsセクションがある
- [ ] TC-08: Output Formatセクションがある
- [ ] TC-09: CSRF-xxx形式のIDがある
- [ ] TC-10: CWE-352の参照がある
- [ ] TC-11: A01:2025の参照がある

### attack-report/reference.md
- [ ] TC-12: CVSS表にcsrfがある
- [ ] TC-13: Agent to Type Mappingにcsrf-attackerがある
- [ ] TC-14: CWE/OWASP表にcsrf (CWE-352)がある

## Phase Log

| Phase | Status | Notes |
|-------|--------|-------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | 14テストケース定義、WARN対応済 |
| plan-review | Done | Score 72 WARN → 35 PASS |
| RED | Done | 15テスト作成、1 PASS / 14 FAIL |
| GREEN | Done | csrf-attacker.md + reference.md更新、15 PASS |
| REFACTOR | Done | リファクタリング不要（既存パターン準拠） |
| REVIEW | Done | quality-gate WARN (72) → 指摘対応済み |
| COMMIT | Done | 4be950a |
