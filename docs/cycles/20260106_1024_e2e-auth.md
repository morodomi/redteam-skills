# Cycle: e2e-auth

| Item | Value |
|------|-------|
| Issue | #25 |
| Phase | DONE |
| Created | 2026-01-06 10:24 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |
| Playwright | ^1.40.0 |

## Goal

認証バイパス脆弱性のE2Eテストを自動生成する。auth-attackerの静的解析結果からPlaywrightテストコードを生成。

## Background

#22 (e2e-generator-base)、#23 (e2e-xss)、#24 (e2e-csrf) で作成した基盤を使用して、認証バイパス専用のテストテンプレートを追加。

## Scope

From Issue #25:
- [ ] auth-attacker結果からテスト生成
- [ ] 未認証アクセス検証
- [ ] 権限昇格検証
- [ ] セッション管理検証

## PLAN

### Design

```
auth-attacker JSON → generate-e2e skill → auth.spec.ts
```

### Architecture

| Component | Description |
|-----------|-------------|
| auth.spec.ts.tmpl | 認証バイパス専用Playwrightテストテンプレート |
| generate-e2e skill | 認証タイプ判定と適切なテスト生成 |

### Auth Test Strategies

| Type | Test Method | Verification |
|------|-------------|--------------|
| unauthenticated-access | 認証なしで保護リソースアクセス | 401/403/redirect = 安全、200 = 脆弱 |
| privilege-escalation | 一般ユーザーで管理者機能アクセス | 403 = 安全、200 = 脆弱 |
| session-fixation | ログイン前後のセッションID比較 | ID変化 = 安全、同一 = 脆弱 |
| idor | 他ユーザーのリソースアクセス | 403 = 安全、200 = 脆弱 |

### auth-attacker Type Mapping

| auth-attacker Type | E2E Test Strategy |
|--------------------|-------------------|
| missing-auth-check | unauthenticated-access |
| broken-access-control | privilege-escalation, idor |
| weak-session | session-fixation |
| hardcoded-credentials | (E2Eテスト対象外、静的解析のみ) |

NOTE: JWT検証は auth-attacker の検出対象外のため、本サイクルではスコープ外とする。

### Files to Create

| File | Description |
|------|-------------|
| plugins/redteam-core/skills/generate-e2e/templates/auth.spec.ts.tmpl | 認証バイパス専用テストテンプレート |

### Template Variables

| Variable | Description | Example |
|----------|-------------|---------|
| {{VULN_ID}} | 脆弱性ID | AUTH-001 |
| {{AUTH_TYPE}} | 認証タイプ | unauthenticated-access |
| {{ENDPOINT}} | テスト対象エンドポイント | /admin/dashboard |
| {{AUTH_ENDPOINT}} | 認証エンドポイント | /login |
| {{AUTH_EMAIL}} | 認証用メールアドレス | test@example.com |
| {{AUTH_PASSWORD}} | 認証用パスワード | password |
| {{ADMIN_EMAIL}} | 管理者メールアドレス | admin@example.com |
| {{ADMIN_PASSWORD}} | 管理者パスワード | adminpass |
| {{USER_ID}} | ユーザーID（IDOR用） | 123 |
| {{OTHER_USER_ID}} | 他ユーザーID（IDOR用） | 456 |

### Output Example

```typescript
// auth.spec.ts (generated)
import { test, expect } from '@playwright/test';

test.describe('Auth Security Tests', () => {
  // Unauthenticated Access Test
  test('AUTH-001: Unauthenticated access to /admin/dashboard', async ({ page }) => {
    const response = await page.goto('/admin/dashboard');
    // 401/403 or redirect expected, 200 = vulnerability
    expect(response?.status()).not.toBe(200);
  });

  // Privilege Escalation Test
  test('AUTH-002: Privilege escalation at /admin/users', async ({ page }) => {
    // Login as regular user
    await page.goto('/login');
    await page.fill('#email', process.env.AUTH_EMAIL || '{{AUTH_EMAIL}}');
    await page.fill('#password', process.env.AUTH_PASSWORD || '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    // Try to access admin-only resource
    const response = await page.goto('/admin/users');
    // 403 expected, 200 = vulnerability
    expect(response?.status()).not.toBe(200);
  });

  // Session Fixation Test
  test('AUTH-003: Session fixation at /login', async ({ page, context }) => {
    await page.goto('/login');
    const cookiesBefore = await context.cookies();
    const sessionBefore = cookiesBefore.find(c => c.name.includes('session'));

    // Login
    await page.fill('#email', process.env.AUTH_EMAIL || '{{AUTH_EMAIL}}');
    await page.fill('#password', process.env.AUTH_PASSWORD || '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    const cookiesAfter = await context.cookies();
    const sessionAfter = cookiesAfter.find(c => c.name.includes('session'));

    // Session ID should change after login
    if (sessionBefore && sessionAfter) {
      expect(sessionAfter.value).not.toBe(sessionBefore.value);
    }
  });

  // IDOR Test
  test('AUTH-004: IDOR at /api/users/456', async ({ page, request }) => {
    // Login as user 123
    await page.goto('/login');
    await page.fill('#email', process.env.AUTH_EMAIL || '{{AUTH_EMAIL}}');
    await page.fill('#password', process.env.AUTH_PASSWORD || '{{AUTH_PASSWORD}}');
    await page.click('button[type="submit"]');

    const cookies = await page.context().cookies();
    const cookieHeader = cookies.map(c => `${c.name}=${c.value}`).join('; ');

    // Try to access other user's data
    const response = await request.get('/api/users/456', {
      headers: { 'Cookie': cookieHeader },
    });
    // 403 expected, 200 = vulnerability
    expect(response.status()).not.toBe(200);
  });
});
```

NOTE: 認証情報は環境変数（process.env.AUTH_EMAIL等）からの取得を推奨。テンプレート変数はフォールバック。

### References

- [OWASP Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [OWASP Authentication Failures](https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/)

## Test List

### TODO

### WIP

### DONE
- [x] TC-01: [正常系] unauthenticated-access検出結果からテスト生成
- [x] TC-02: [正常系] privilege-escalation検出結果からテスト生成
- [x] TC-03: [正常系] session-fixation検出結果からテスト生成
- [x] TC-04: [正常系] idor検出結果からテスト生成
- [x] TC-05: [境界値] Auth脆弱性0件時の処理
- [x] TC-06: [エッジケース] 複数認証タイプ混在
- [x] TC-07: [異常系] 不正なAuthタイプ指定時のエラー

## REVIEW

### quality-gate Results

| Agent | Score | Status |
|-------|-------|--------|
| Correctness | 62 | WARN |
| Performance | 35 | PASS |
| Security | 35 | PASS |
| Guidelines | 35 | PASS |

**Max Score: 62 (WARN)**

### Fixed Issues

- Session fixation test comment clarified (PoC semantics)
- Added explicit session cookie existence checks

### Accepted Limitations

- Custom session cookie names may require template variable extension
- Pre-login session cookie requirement is documented in error message

## Notes

- 依存: #22 e2e-generator-base (完了)
- 検証タイプ: 未認証アクセス、権限昇格、セッション固定、IDOR
