# TDD Cycle: OWASP 2025 Coverage

## Overview

| Item | Value |
|------|-------|
| Feature | OWASP Top 10 2025 カバレッジ拡張 |
| Issue | #10 |
| Phase | COMMIT |
| Started | 2025-12-25 00:02 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

OWASP Top 10 2025 RCに基づき、静的解析可能なカテゴリのカバレッジを拡張する。

### MVP対象

| Agent | OWASP 2025 | 検出対象 |
|-------|-----------|---------|
| crypto-attacker | A02, A04 | 設定ミス、暗号の問題 |
| error-attacker | A10 | 例外処理の問題 |

### 対象外（将来）

- A03 Supply Chain Failures（SCAツール必要）
- A06 Insecure Design（静的解析困難）
- A09 Logging Failures（実行時判断）

## Background

### OWASP Top 10 2025 RC

| # | Category | Status |
|---|----------|--------|
| A01 | Broken Access Control | auth-attacker対応済 |
| A02 | Security Misconfiguration | **crypto-attacker** |
| A03 | Supply Chain Failures | 対象外（SCA必要） |
| A04 | Cryptographic Failures | **crypto-attacker** |
| A05 | Injection | injection/xss-attacker対応済 |
| A06 | Insecure Design | 対象外 |
| A07 | Authentication Failures | auth-attacker対応済 |
| A08 | Integrity Failures | 将来検討 |
| A09 | Logging Failures | 対象外 |
| A10 | Exceptional Conditions | **error-attacker** |

## Agent Design

### 1. crypto-attacker

```yaml
name: crypto-attacker
description: 暗号・設定脆弱性検出エージェント。A02 Security Misconfiguration + A04 Cryptographic Failures。
allowed-tools: Read, Grep, Glob
```

#### 検出対象

| Type | Description | Pattern Example |
|------|-------------|-----------------|
| debug-enabled | デバッグモード有効 | DEBUG = True |
| weak-hash | 弱いハッシュ関数 | md5(, sha1( |
| weak-crypto | 弱い暗号アルゴリズム | DES, RC4, ECB |
| default-credentials | デフォルト認証情報 | admin/admin |
| insecure-cors | 危険なCORS設定 | Access-Control-Allow-Origin: * |

※ hardcoded-secret は auth-attacker で対応済（CWE-798重複回避）

#### CWE Mapping

| Type | CWE |
|------|-----|
| debug-enabled | CWE-489 |
| weak-hash | CWE-328 |
| weak-crypto | CWE-327 |
| default-credentials | CWE-1392 |
| insecure-cors | CWE-942 |

### 2. error-attacker

```yaml
name: error-attacker
description: 例外処理脆弱性検出エージェント。A10 Mishandling of Exceptional Conditions。
allowed-tools: Read, Grep, Glob
```

#### 検出対象

| Type | Description | Pattern Example |
|------|-------------|-----------------|
| empty-catch | 空のcatch/exceptブロック | catch (e) {} |
| swallowed-exception | 例外の握りつぶし | except: pass |
| fail-open | 失敗時にオープン | return true on error |
| generic-exception | 汎用例外キャッチ | catch (Exception e) |
| missing-finally | リソース解放漏れ | no finally block |

#### CWE Mapping

| Type | CWE |
|------|-----|
| empty-catch | CWE-390 |
| swallowed-exception | CWE-391 |
| fail-open | CWE-636 |
| generic-exception | CWE-396 |
| missing-finally | CWE-404 |

## PLAN

### スコープ

2つの新規エージェントを作成し、security-scan/attack-reportに統合する。

### ファイル構成

```
plugins/redteam-core/
├── agents/
│   ├── crypto-attacker.md   # NEW: A02 + A04
│   └── error-attacker.md    # NEW: A10
└── skills/
    ├── security-scan/
    │   ├── SKILL.md          # UPDATE: Agent Integration
    │   └── reference.md      # UPDATE: 新エージェント追加
    └── attack-report/
        └── reference.md      # UPDATE: CVSS/CWEマッピング追加
scripts/
├── test-crypto-attacker.sh  # NEW
└── test-error-attacker.sh   # NEW
```

### Phase 1: crypto-attacker

OWASP A02 Security Misconfiguration + A04 Cryptographic Failures

#### 検出パターン

```yaml
patterns:
  # Debug Enabled (CWE-489)
  - 'DEBUG\s*=\s*True'
  - 'APP_DEBUG\s*=\s*true'
  - 'debug:\s*true'

  # Weak Hash (CWE-328)
  - 'md5\s*\('
  - 'sha1\s*\('
  - 'hashlib\.md5'
  - 'hashlib\.sha1'

  # Weak Crypto (CWE-327)
  - 'DES\.'
  - 'RC4'
  - 'ECB'
  - 'Blowfish'

  # Default Credentials (CWE-1392)
  - 'admin.*admin'
  - 'root.*root'
  - 'password.*password'

  # Insecure CORS (CWE-942)
  - 'Access-Control-Allow-Origin:\s*\*'
  - 'CORS_ALLOW_ALL'
  - 'cors\(\s*\)'
```

#### Severity Mapping

| Type | Severity |
|------|----------|
| weak-crypto | high |
| weak-hash | high |
| default-credentials | high |
| debug-enabled | medium |
| insecure-cors | medium |

### Phase 2: error-attacker

OWASP A10 Mishandling of Exceptional Conditions

#### 検出パターン

```yaml
patterns:
  # Empty Catch (CWE-390)
  - 'catch\s*\([^)]*\)\s*\{\s*\}'           # JS/TS/PHP
  - 'except:\s*pass'                         # Python
  - 'rescue\s*=>\s*nil'                      # Ruby

  # Swallowed Exception (CWE-391)
  - 'catch\s*\([^)]*\)\s*\{\s*//.*\}'        # Comment only
  - 'except.*:\s*#.*\n\s*pass'               # Python comment

  # Fail Open (CWE-636)
  - 'catch.*return\s+true'
  - 'except.*return\s+True'
  - 'on error resume next'

  # Generic Exception (CWE-396)
  - 'catch\s*\(\s*Exception\s+\w+\s*\)'      # Java/PHP
  - 'except\s+Exception\s*:'                 # Python
  - 'catch\s*\(\s*\w+\s*\)'                  # JS (any)

  # Missing Finally (CWE-404)
  - 'try\s*\{[^}]*\}\s*catch\s*\([^)]*\)\s*\{[^}]*\}\s*[^f]'
```

#### Severity Mapping

| Type | Severity |
|------|----------|
| fail-open | critical |
| empty-catch | high |
| swallowed-exception | high |
| generic-exception | medium |
| missing-finally | low |

### Phase 3: Integration

1. security-scan: Agent Integrationセクションに追加
2. attack-report/reference.md: CVSS 4.0マッピング追加

#### CVSS 4.0追加マッピング

| Type | CVSS 4.0 Vector | Score |
|------|-----------------|-------|
| debug-enabled | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:L/VI:N/VA:N/SC:N/SI:N/SA:N | 5.3 |
| weak-hash | CVSS:4.0/AV:N/AC:H/AT:N/PR:N/UI:N/VC:H/VI:N/VA:N/SC:N/SI:N/SA:N | 5.9 |
| weak-crypto | CVSS:4.0/AV:N/AC:H/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 7.4 |
| default-credentials | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 |
| insecure-cors | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:A/VC:L/VI:L/VA:N/SC:N/SI:N/SA:N | 4.8 |
| empty-catch | CVSS:4.0/AV:N/AC:L/AT:P/PR:N/UI:N/VC:N/VI:N/VA:H/SC:N/SI:N/SA:N | 6.3 |
| swallowed-exception | CVSS:4.0/AV:N/AC:L/AT:P/PR:N/UI:N/VC:N/VI:N/VA:H/SC:N/SI:N/SA:N | 6.3 |
| fail-open | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 |
| generic-exception | CVSS:4.0/AV:N/AC:H/AT:P/PR:N/UI:N/VC:N/VI:N/VA:L/SC:N/SI:N/SA:N | 2.3 |
| missing-finally | CVSS:4.0/AV:L/AC:H/AT:P/PR:N/UI:N/VC:N/VI:N/VA:L/SC:N/SI:N/SA:N | 1.8 |

## Test List

### Phase 1: crypto-attacker

#### DONE
- [x] TC-01: crypto-attacker.mdが存在する
- [x] TC-02: YAMLフロントマターにname, description, allowed-toolsが定義されている
- [x] TC-03: Detection Targetsに5タイプが定義されている
- [x] TC-04: debug-enabled検出パターンが存在する
- [x] TC-05: weak-hash検出パターン（md5, sha1）が存在する
- [x] TC-06: weak-crypto検出パターン（DES, RC4, ECB）が存在する
- [x] TC-07: CWE Mappingセクションが存在する
- [x] TC-08: Severity Criteriaが定義されている

### Phase 2: error-attacker

#### DONE
- [x] TC-09: error-attacker.mdが存在する
- [x] TC-10: YAMLフロントマターにname, description, allowed-toolsが定義されている
- [x] TC-11: Detection Targetsに5タイプが定義されている
- [x] TC-12: empty-catch検出パターンが存在する
- [x] TC-13: fail-open検出パターンが存在する
- [x] TC-14: CWE Mappingセクションが存在する
- [x] TC-15: Severity Criteriaが定義されている
- [x] TC-16: 複数言語対応（JS, Python, PHP）のパターンが存在する

### Phase 3: Integration

#### TODO
- [ ] TC-17: security-scan SKILL.mdにcrypto-attacker統合
- [ ] TC-18: security-scan SKILL.mdにerror-attacker統合
- [ ] TC-19: attack-report reference.mdに新CVSSマッピング追加
- [ ] TC-20: attack-report reference.mdに新CWEマッピング追加

## References

- [OWASP Top 10:2025 RC](https://owasp.org/Top10/2025/)
- [A02:2025 Security Misconfiguration](https://owasp.org/Top10/2025/A02_2025-Security_Misconfiguration/)
- [A04:2025 Cryptographic Failures](https://owasp.org/Top10/2025/A04_2025-Cryptographic_Failures/)
- [A10:2025 Exceptional Conditions](https://owasp.org/Top10/2025/A10_2025-Mishandling_of_Exceptional_Conditions/)

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成、スコープ決定 |
| PLAN | Done | 2エージェント設計、Test List 20件、plan-review後修正（hardcoded-secret削除、missing-finally CVSS追加） |
| RED | Done | 16テスト失敗確認（crypto: 8, error: 8） |
| GREEN | Done | 2エージェント作成、16テスト成功 |
| REFACTOR | Done | リファクタリング不要（構造一貫性OK） |
| REVIEW | Done | 16テスト全PASS、code-review完了（Critical 0件） |
| COMMIT | Done | 4226010 - Phase 1-2完了 |
