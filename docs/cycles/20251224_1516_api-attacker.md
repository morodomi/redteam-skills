# TDD Cycle: api-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | api-attacker API攻撃エージェント |
| Issue | #8 |
| Phase | INIT |
| Started | 2024-12-24 15:16 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

API固有の脆弱性を検出するエージェントを実装する。

### MVP対象
- Mass Assignment
- BOLA (Broken Object Level Authorization)
- Rate Limiting Missing
- Excessive Data Exposure

## PLAN

### スコープ

api-attackerエージェントファイルの作成。静的解析によるAPI固有脆弱性の検出。

### ファイル構成

```
plugins/redteam-core/agents/
└── api-attacker.md    # API攻撃エージェント定義
```

### エージェント設計

```yaml
name: api-attacker
description: API脆弱性検出エージェント。静的解析でAPI Security Top 10脆弱性を検出。
allowed-tools: Read, Grep, Glob
```

### 検出対象（MVP）

| Type | Description | Pattern |
|------|-------------|---------|
| Mass Assignment | 一括代入脆弱性 | $request->all(), fillable未定義 |
| BOLA | オブジェクトレベル認可不備 | IDパラメータの権限チェック漏れ |
| Rate Limiting | レート制限なし | throttle未設定のAPI |
| Excessive Data Exposure | 過剰なデータ露出 | 全カラム返却、機密フィールド露出 |

### フレームワーク別検出パターン

| Framework | Vulnerable Pattern | Safe Pattern |
|-----------|-------------------|--------------|
| Laravel | `$request->all()`, `Model::create($input)` | `$request->only()`, `$fillable` |
| Django | `Model(**request.data)` | Serializer with fields |
| Flask | `Model(**request.json)` | Schema validation |
| Express | `Model.create(req.body)` | Validation middleware |

### 危険パターン（Grep対象）

```yaml
patterns:
  # Mass Assignment
  - '\$request->all\s*\(\)'
  - 'Model::create\s*\(\s*\$request'
  - '\*\*request\.(data|json)'
  - 'create\s*\(\s*req\.body\s*\)'

  # BOLA - Missing ownership check
  - 'find\s*\(\s*\$id\s*\)'
  - 'findOrFail\s*\(\s*\$'
  - 'get_object_or_404\s*\('

  # Rate Limiting Missing
  - 'Route::.*->middleware\s*\([^)]*(?!throttle)'

  # Excessive Data Exposure
  - 'return\s+\$\w+->toArray\s*\(\)'
  - '->get\s*\(\)\s*$'
  - 'SELECT\s+\*\s+FROM'
```

### 出力形式

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "agent": "api-attacker"
  },
  "vulnerabilities": [
    {
      "id": "API-001",
      "type": "mass-assignment",
      "severity": "high",
      "file": "app/Http/Controllers/UserController.php",
      "line": 34,
      "code": "User::create($request->all())",
      "description": "Mass assignment vulnerability - all request data passed to create",
      "remediation": "Use $request->only(['name', 'email']) or define $fillable"
    }
  ],
  "summary": {
    "total": 1,
    "critical": 0,
    "high": 1,
    "medium": 0,
    "low": 0
  }
}
```

### 重大度基準

| Severity | Criteria |
|----------|----------|
| critical | BOLA on sensitive resources (admin, payment) |
| high | Mass Assignment, Excessive Data Exposure |
| medium | Rate Limiting missing on auth endpoints |
| low | Rate Limiting missing on public endpoints |

### CWE/OWASP マッピング

| Reference | ID |
|-----------|-----|
| CWE | CWE-915: Mass Assignment |
| CWE | CWE-639: IDOR/BOLA |
| OWASP API Top 10 | API1:2023 BOLA |
| OWASP API Top 10 | API3:2023 Broken Object Property Level Authorization |

## Test List

### DONE
- [x] TC-01: api-attacker.md が存在する
- [x] TC-02: YAML frontmatter（name, description, allowed-tools）が存在する
- [x] TC-03: 検出対象セクション（Mass Assignment, BOLA, Rate Limiting）が存在する
- [x] TC-04: フレームワーク別検出パターン表が存在する
- [x] TC-05: 危険パターン（Grepパターン）が定義されている
- [x] TC-06: 出力形式（JSONスキーマ）が存在する
- [x] TC-07: 重大度基準が存在する
- [x] TC-08: CWE/OWASPマッピングが存在する

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | エージェント設計、Test List作成 |
| RED | Done | 8テスト作成、全失敗確認 |
| GREEN | Done | api-attacker.md作成、全テスト成功 |
| REFACTOR | Done | リファクタリング不要（構造クリーン） |
| REVIEW | Done | テスト全PASS、code-review完了（API2-10=Issue#10対象） |
| COMMIT | - | |

## References

- [OWASP API Security Top 10](https://owasp.org/API-Security/editions/2023/en/0x11-t10/)
