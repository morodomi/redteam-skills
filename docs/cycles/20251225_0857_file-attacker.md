# TDD Cycle: file-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | file-attacker: ファイル攻撃エージェント |
| Issue | #11 |
| Phase | INIT |
| Started | 2025-12-25 08:57 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

ファイル関連の脆弱性を検出するエージェントを実装する。

### 検出対象（予定）

| Type | Description | CWE |
|------|-------------|-----|
| path-traversal | パストラバーサル | CWE-22 |
| arbitrary-file-upload | 任意ファイルアップロード | CWE-434 |
| lfi | ローカルファイルインクルージョン | CWE-98 |
| unrestricted-file-access | 制限のないファイルアクセス | CWE-552 |

### OWASP Mapping

- A01:2025 Broken Access Control
- A03:2025 Injection (LFI)

## Background

### 既存エージェント構成

| Agent | Target |
|-------|--------|
| recon-agent | 情報収集 |
| injection-attacker | SQLi |
| xss-attacker | XSS |
| auth-attacker | 認証 |
| api-attacker | API |
| crypto-attacker | 暗号・設定 |
| error-attacker | 例外処理 |

### 参考パターン

他エージェントと同様の構成:
- YAML frontmatter (name, description, allowed-tools)
- Detection Targets
- Detection Patterns (言語別)
- CWE Mapping
- Severity Criteria
- Output Format

## PLAN

### スコープ

file-attacker エージェントを新規作成し、security-scan/attack-report に統合する。

### ファイル構成

```
plugins/redteam-core/
├── agents/
│   └── file-attacker.md       # NEW
└── skills/
    ├── security-scan/
    │   ├── SKILL.md           # UPDATE: Agent Integration
    │   └── reference.md       # UPDATE: Phase 2 SCAN
    └── attack-report/
        └── reference.md       # UPDATE: CVSS/CWE Mapping
scripts/
└── test-file-attacker.sh      # NEW
```

### Detection Targets

| Type | Description | CWE | Severity |
|------|-------------|-----|----------|
| path-traversal | `../` を使ったディレクトリ遡上 | CWE-22 | critical |
| arbitrary-file-upload | 拡張子/MIME検証なしアップロード | CWE-434 | critical |
| lfi | ローカルファイルインクルージョン | CWE-98 | critical |
| unrestricted-file-access | 制限なしファイルアクセス | CWE-552 | high |

### Detection Patterns

```yaml
patterns:
  # Path Traversal (CWE-22)
  - 'file_get_contents\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'fopen\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'readfile\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'open\s*\(\s*request\.(args|form)'
  - 'fs\.readFile\s*\(\s*req\.(query|body)'

  # Arbitrary File Upload (CWE-434)
  - 'move_uploaded_file\s*\('
  - '\$_FILES\s*\['
  - 'request\.files'
  - 'multer\('

  # LFI (CWE-98)
  - 'include\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'require\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'include_once\s*\(\s*\$'
  - 'require_once\s*\(\s*\$'

  # Unrestricted File Access (CWE-552)
  - 'X-Sendfile'
  - 'X-Accel-Redirect'
  - 'send_file\s*\('
  - 'res\.sendFile\s*\('
```

### CVSS 4.0 Mapping

| Type | CVSS 4.0 Vector | Score | Note |
|------|-----------------|-------|------|
| path-traversal | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 | 書き込み可能前提 |
| arbitrary-file-upload | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N | 9.1 | RCE可能前提、VA:N修正 |
| lfi | CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:L/VA:N/SC:N/SI:N/SA:N | 8.8 | 読み取り主体、VI:L修正 |
| unrestricted-file-access | CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:N/VC:H/VI:N/VA:N/SC:N/SI:N/SA:N | 6.5 | |

### Vulnerability ID Prefix

`FILE-XXX` 形式を使用（例: FILE-001, FILE-002）

### CWE/OWASP Mapping

| Type | CWE | OWASP |
|------|-----|-------|
| path-traversal | CWE-22 | A01:2025 |
| arbitrary-file-upload | CWE-434 | A01:2025 |
| lfi | CWE-98 | A03:2025 |
| unrestricted-file-access | CWE-552 | A01:2025 |

## Test List

### TODO
- [ ] TC-01: file-attacker.mdが存在する
- [ ] TC-02: YAMLフロントマターにname, description, allowed-toolsが定義
- [ ] TC-03: Detection Targetsに4タイプが定義
- [ ] TC-04: path-traversal検出パターンが存在
- [ ] TC-05: arbitrary-file-upload検出パターンが存在
- [ ] TC-06: lfi検出パターンが存在
- [ ] TC-07: unrestricted-file-access検出パターンが存在
- [ ] TC-08: CWE Mappingセクションが存在（4件）
- [ ] TC-09: Severity Criteriaが定義
- [ ] TC-10: Vulnerability ID Prefix（FILE-XXX）が定義

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | 設計完了、plan-review後修正（CVSS修正、Test List 10件） |
| RED | Done | 10テスト失敗確認 |
| GREEN | Done | 10テスト全PASS |
| REFACTOR | Done | リファクタリング不要（構造一貫性OK） |
| REVIEW | Done | code-review 3観点完了、Critical 3件修正 |
| COMMIT | Done | |
