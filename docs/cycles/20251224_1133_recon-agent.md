# TDD Cycle: recon-agent

## Overview

| Item | Value |
|------|-------|
| Feature | recon-agent 偵察エージェント実装 |
| Issue | #2 |
| Phase | INIT |
| Started | 2024-12-24 11:33 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

情報収集フェーズを担当するエージェントを実装し、対象コードベースからセキュリティ監査に必要な情報を収集する。

## PLAN

### スコープ

recon-agentエージェントファイルの作成。以下のフレームワークに対応:
- PHP: Laravel
- Python: Django, Flask
- Node.js: Express

### ファイル構成

```
plugins/redteam-core/agents/
└── recon-agent.md    # 偵察エージェント定義
```

### エージェント設計

```yaml
name: recon-agent
description: 偵察エージェント。エンドポイント列挙、技術スタック特定、攻撃優先度付け。
allowed-tools: Bash, Read, Grep, Glob
```

### 検出機能

| 機能 | 検出対象 | 方法 |
|------|---------|------|
| エンドポイント列挙 | routes, API | ルーティングファイル解析 |
| 技術スタック特定 | FW, DB, 認証 | 設定ファイル解析 |
| 攻撃優先度付け | 入力受付箇所 | パラメータ解析 |

### フレームワーク検出

| Framework | Detection | Route Extraction |
|-----------|-----------|------------------|
| Laravel | composer.json (laravel/framework) | routes/web.php, routes/api.php |
| Django | manage.py, settings.py | urls.py (urlpatterns) |
| Flask | requirements.txt (Flask) | @app.route() decorators |
| Express | package.json (express) | app.get/post/put/delete() |

### スキャン対象

```yaml
include:
  - app/
  - routes/
  - config/
  - src/
exclude:
  - tests/
  - vendor/
  - node_modules/
  - .env
  - .env.*
```

### 機密データ除外ルール

以下のデータは**収集しない**:
- 環境変数の値（DB_PASSWORD, API_KEY, SECRET等）
- 認証トークン、暗号化キー
- ユーザーデータ（メールアドレス、個人情報）
- 接続文字列

### 出力形式

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "target_directory": "<path>"
  },
  "framework": {
    "name": "Laravel",
    "version": "11.x"
  },
  "endpoints": [
    {
      "method": "POST",
      "path": "/api/users",
      "parameters": ["name", "email", "password"],
      "auth_required": true,
      "file": "routes/api.php",
      "line": 15
    }
  ],
  "tech_stack": {
    "database": "MySQL",
    "authentication": "Sanctum",
    "cache": "Redis"
  },
  "attack_priorities": [
    {
      "endpoint": "/api/users",
      "priority": "high",
      "reason": "User input without validation",
      "suggested_attacks": ["injection", "auth-bypass"]
    }
  ]
}
```

### 攻撃優先度基準

| Priority | Criteria |
|----------|----------|
| critical | 認証なし + DB操作 + ユーザー入力 |
| high | 認証あり + DB操作 + ユーザー入力 |
| medium | 認証あり + ユーザー入力 |
| low | 認証あり + 入力なし |

## Test List

### DONE
- [x] TC-01: recon-agent.md が存在する
- [x] TC-02: YAML frontmatter（name, description, allowed-tools）が存在する
- [x] TC-03: 検出対象セクションが存在する
- [x] TC-04: フレームワーク検出表が存在する（Laravel, Django, Flask, Express）
- [x] TC-05: スキャン対象（include/exclude）が定義されている
- [x] TC-06: 機密データ除外ルールが存在する
- [x] TC-07: 出力形式（JSONスキーマ）が存在する
- [x] TC-08: 攻撃優先度基準が存在する

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | エージェント設計、Test List作成 |
| RED | Done | 8テスト作成、全失敗確認 |
| GREEN | Done | recon-agent.md作成、全テスト成功 |
| REFACTOR | Done | 不要な.gitkeep削除 |
| REVIEW | Done | テスト全PASS、code-review完了（Critical=実装詳細） |
| COMMIT | - | |

## References

- [OWASP Testing Guide - Information Gathering](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/)
- [tdd-skills agents](https://github.com/morodomi/tdd-skills/tree/main/plugins/tdd-core/agents)
