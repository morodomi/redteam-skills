# TDD Cycle: ssrf-attacker

## Overview

| Item | Value |
|------|-------|
| Feature | ssrf-attacker: SSRF攻撃エージェント |
| Issue | #12 |
| Phase | INIT |
| Started | 2025-12-25 10:12 |

## Environment

| Tool | Version |
|------|---------|
| Claude Code | 2.0.75 |
| Platform | darwin (macOS) |

## Goal

Server-Side Request Forgery (SSRF) 脆弱性を検出するエージェントを実装する。

### 検出対象（予定）

| Type | Description | CWE |
|------|-------------|-----|
| ssrf | サーバーサイドリクエストフォージェリ | CWE-918 |
| blind-ssrf | ブラインドSSRF | CWE-918 |
| partial-ssrf | URL一部のみユーザー制御 | CWE-918 |

### OWASP Mapping

- A10:2021 Server-Side Request Forgery (SSRF)
- A01:2025 Broken Access Control (SSRFはここに統合)

## Background

### 既存エージェント構成

| Agent | Target |
|-------|--------|
| recon-agent | 情報収集 |
| injection-attacker | SQLi |
| xss-attacker | XSS |
| auth-attacker | 認証 |
| api-attacker | API |
| crypto-attacker | 暗号・設定 |
| error-attacker | 例外処理 |
| file-attacker | ファイル操作 |

### 参考パターン

他エージェントと同様の構成:
- YAML frontmatter (name, description, allowed-tools)
- Detection Targets
- Detection Patterns (言語別)
- CWE Mapping
- Severity Criteria
- Output Format
- Known Limitations

## PLAN

### スコープ

ssrf-attacker エージェントを新規作成する。

### ファイル構成

```
plugins/redteam-core/
├── agents/
│   └── ssrf-attacker.md       # NEW
scripts/
└── test-ssrf-attacker.sh      # NEW
```

### Detection Targets

| Type | Description | CWE | Severity |
|------|-------------|-----|----------|
| ssrf | ユーザー入力URLへのリクエスト | CWE-918 | critical |
| blind-ssrf | レスポンス非表示のSSRF | CWE-918 | high |
| partial-ssrf | URL一部のみユーザー制御 | CWE-918 | medium |

### Detection Patterns

```yaml
patterns:
  # PHP - SSRF
  - 'file_get_contents\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'curl_setopt\s*\([^,]+,\s*CURLOPT_URL\s*,\s*\$'
  - 'fopen\s*\(\s*\$_(GET|POST|REQUEST)'

  # Python - SSRF
  - 'requests\.(get|post|put|delete|head)\s*\(\s*request\.'
  - 'urllib\.request\.urlopen\s*\(\s*request\.'
  - 'httpx\.(get|post)\s*\(\s*request\.'

  # Node.js - SSRF
  - 'axios\.(get|post)\s*\(\s*req\.(query|body|params)'
  - 'fetch\s*\(\s*req\.(query|body|params)'
  - 'http\.request\s*\(\s*req\.'
  - 'got\s*\(\s*req\.(query|body|params)'

  # Java - SSRF
  - 'new\s+URL\s*\(\s*request\.getParameter'
  - 'HttpURLConnection.*request\.getParameter'
  - 'RestTemplate.*request\.getParameter'

  # Dangerous URL Parsing
  - 'parse_url\s*\(\s*\$_(GET|POST|REQUEST)'
  - 'urlparse\s*\(\s*request\.'
  - 'new\s+URL\s*\(\s*req\.'

  # Cloud Metadata Services (Hardcoded targets)
  - '169\.254\.169\.254'
  - 'metadata\.google\.internal'
  - 'metadata\.azure\.com'
```

### Vulnerability ID Prefix

`SSRF-XXX` 形式を使用（例: SSRF-001, SSRF-002）

### CWE/OWASP Mapping

| Type | CWE | OWASP |
|------|-----|-------|
| ssrf | CWE-918 | A10:2021, A01:2025 |
| blind-ssrf | CWE-918 | A10:2021, A01:2025 |
| partial-ssrf | CWE-918 | A10:2021, A01:2025 |

### Output Format

```json
{
  "metadata": {
    "scan_id": "<uuid>",
    "scanned_at": "<timestamp>",
    "agent": "ssrf-attacker"
  },
  "vulnerabilities": [
    {
      "id": "SSRF-001",
      "type": "ssrf",
      "severity": "critical",
      "file": "app/Http/Controllers/WebhookController.php",
      "line": 45,
      "code": "file_get_contents($_GET['callback_url'])",
      "description": "User-controlled URL passed to HTTP request function",
      "remediation": "Validate URL against allowlist of domains/schemes"
    }
  ],
  "summary": {
    "total": 1,
    "critical": 1,
    "high": 0,
    "medium": 0,
    "low": 0
  }
}
```

### Workflow

1. **Scan Files**: Use Glob to find source files (*.php, *.py, *.js, *.ts, *.java)
2. **Pattern Match**: Use Grep to find HTTP request patterns with user input
3. **Analyze Context**: Use Read to examine URL validation and allowlisting
4. **Determine Severity**: Score based on response visibility and input control
5. **Generate Report**: Output vulnerabilities in JSON format

### Known Limitations

- Pattern matching may produce false positives for:
  - Framework-provided HTTP client wrappers with built-in validation
  - URL construction with validated components only

- Cannot detect:
  - Runtime URL validation logic (requires code flow analysis)
  - DNS rebinding attacks (dynamic DNS behavior)
  - Second-order SSRF (stored URLs executed later)

- Accuracy depends on:
  - Code being within scanned file scope
  - Consistent naming conventions for user input variables

## Test List

### TODO
- [ ] TC-01: ssrf-attacker.mdが存在する
- [ ] TC-02: YAMLフロントマターにname, description, allowed-toolsが定義
- [ ] TC-03: Detection Targetsに3タイプが定義
- [ ] TC-04: PHP SSRF検出パターンが存在
- [ ] TC-05: Python SSRF検出パターンが存在
- [ ] TC-06: Node.js SSRF検出パターンが存在
- [ ] TC-07: Java SSRF検出パターンが存在
- [ ] TC-08: Cloud Metadata検出パターンが存在
- [ ] TC-09: CWE-918 Mappingが存在
- [ ] TC-10: Severity Criteriaが定義
- [ ] TC-11: Vulnerability ID Prefix（SSRF-XXX）が定義
- [ ] TC-12: Known Limitationsセクションが存在

## Phase Log

| Phase | Status | Note |
|-------|--------|------|
| INIT | Done | Cycle doc作成 |
| PLAN | Done | 設計完了、plan-review後修正、Test List 12件 |
| RED | Done | 12テスト失敗確認 |
| GREEN | Done | 12テスト全PASS |
| REFACTOR | Done | リファクタリング不要（構造一貫性OK） |
| REVIEW | Done | code-review 3観点、Critical 2件修正 |
| COMMIT | Done | |
