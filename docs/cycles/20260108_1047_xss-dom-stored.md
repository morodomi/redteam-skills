# Cycle: xss-dom-stored

| Item | Value |
|------|-------|
| Issue | #28 |
| Phase | PLAN |
| Created | 2026-01-08 10:47 |

## Environment

| Tool | Version |
|------|---------|
| Node.js | v22.17.0 |

## Goal

xss-attackerにDOM XSSとStored XSSの検出機能を追加する。現在はReflected XSSのみ対応。

## Background

From Issue #28:
- 現在xss-attackerはReflected XSSのみ検出可能
- #23 (e2e-xss) でE2Eテストテンプレートは3タイプ対応済み
- attacker側の検出機能を拡張して完全対応

## Scope

From Issue #28:
- [ ] DOM XSS検出パターン追加
- [ ] Stored XSS検出パターン追加
- [ ] Output FormatにDOM/Storedタイプ追加
- [ ] テスト追加

## PLAN

### Design

```
xss-attacker.md
├── Detection Targets (既存: reflected → 追加: dom, stored)
├── Framework Detection Patterns (既存 + DOM/Stored追加)
├── Dangerous Patterns (既存 + DOM/Stored追加)
└── Output Format (type: "reflected" | "dom" | "stored")
```

### XSS Type Definitions

| Type | Description | Detection Approach |
|------|-------------|-------------------|
| reflected | URL/リクエストパラメータが即時出力 | 入力→出力の直接フロー |
| dom | クライアントサイドで入力がDOMに反映 | 危険なSink使用パターン |
| stored | DBに保存後、別リクエストで出力 | 保存→取得→出力フロー |

### DOM XSS Detection Patterns

| Category | Dangerous Sink | Pattern |
|----------|---------------|---------|
| DOM操作 | innerHTML | `\.innerHTML\s*=` |
| DOM操作 | outerHTML | `\.outerHTML\s*=` |
| DOM操作 | document.write | `document\.write\s*\(` |
| 実行系 | eval | `eval\s*\(.*location` |
| jQuery | html() | `\.html\s*\([^)]*\$` |
| jQuery | append() | `\.append\s*\([^)]*\$` |

Sources（トレース対象）:
- `location.hash`, `location.search`
- `document.URL`, `document.referrer`
- `window.name`

### Stored XSS Detection Patterns

| Framework | Save Pattern | Display Pattern |
|-----------|-------------|-----------------|
| Laravel | `->create($request->all())` | `{!! $model->field !!}` |
| Django | `.objects.create(**request.POST)` | `{{ field\|safe }}` |
| Express | `collection.insertOne(req.body)` | `innerHTML = data.field` |

NOTE: 静的解析の限界上、保存と表示の紐付けは同一モデル/変数名での推定。

### Files to Modify

| File | Changes |
|------|---------|
| plugins/redteam-core/agents/xss-attacker.md | DOM/Stored検出パターン追加 |

### Output Format Changes

```json
{
  "vulnerabilities": [
    {
      "id": "XSS-001",
      "type": "dom",           // "reflected" | "dom" | "stored"
      "vulnerability_class": "xss",
      "cwe_id": "CWE-79",
      ...
    }
  ]
}
```

### CWE Mapping

| Type | CWE |
|------|-----|
| reflected | CWE-79 |
| dom | CWE-79 (DOM-based subset) |
| stored | CWE-79 (Persistent XSS) |

NOTE: すべてCWE-79だが、レポートのtypeで区別。

## Test List

### TODO

### WIP

### DONE
- [x] TC-01: [正常系] DOM XSS innerHTML検出
- [x] TC-02: [正常系] DOM XSS document.write検出
- [x] TC-03: [正常系] DOM XSS jQuery.html()検出
- [x] TC-04: [正常系] Stored XSS Laravel検出
- [x] TC-05: [正常系] Stored XSS Django検出
- [x] TC-06: [正常系] Stored XSS Express検出
- [x] TC-07: [境界値] 安全なパターン（エスケープ済み）除外
- [x] TC-08: [エッジケース] 複数タイプ混在
- [x] TC-09: [異常系] 対象ファイルなし

## REVIEW

### quality-gate Results

| Agent | Score | Status |
|-------|-------|--------|
| Correctness | 25 | PASS |
| Performance | 25 | PASS |
| Security | 35 | PASS |
| Guidelines | 25 | PASS |

**Max Score: 35 (PASS)**

### Optional Improvements (Future)

- insertAdjacentHTML, setHTMLUnsafe パターン追加
- Vue.js v-html, React dangerouslySetInnerHTML パターン追加
- Known Limitations セクション追加

## Notes

- 依存: #23 e2e-xss (テンプレート側は対応済み)
